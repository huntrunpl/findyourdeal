import dotenv from "dotenv";
dotenv.config();

import fetch from "node-fetch";
import pg from "pg";

import {
  initDb,
  ensureUser,
  getUserWithPlanByTelegramId,
  getUserById,
  getUserIdByTelegramId,
  getLinksByUserId,
  countActiveLinksForUserId,
  countEnabledLinksForUserId,
  insertLinkForUserId,
  deactivateLinkForUserId,
  setQuietHours,
  disableQuietHours,
  getQuietHours,
} from "./db.js";
import { clearLinkNotificationMode } from "./db.js";

import {
  getEffectiveLinkLimit,
  formatPlanStatus,
  isPlanActive,
  buildLimitReachedMessage,
  getPerLinkItemLimit,
  getExtraLinkPacks,
} from "./plans.js";

const { Pool } = pg;

const TG = process.env.TELEGRAM_BOT_TOKEN || "";
const DATABASE_URL = process.env.DATABASE_URL || "";
const ADMIN_TG_ID = process.env.ADMIN_TG_ID ? String(process.env.ADMIN_TG_ID) : null;

if (!TG) {
  console.error("Brak TELEGRAM_BOT_TOKEN w env, wychodzÄ™.");
  process.exit(1);
}

if (!DATABASE_URL) {
  console.error("Brak DATABASE_URL w env â€“ bot moÅ¼e mieÄ‡ problem z DB.");
}

const pool = new Pool({
  connectionString: DATABASE_URL,
});

// limit dzienny powiadomieÅ„ na jeden chat â€“ informacyjnie do /status
const MAX_DAILY_NOTIFICATIONS = 200;

// ---------- helpery ogÃ³lne ----------

async function dbQuery(sql, params = []) {
  const client = await pool.connect();
  try {
    return await client.query(sql, params);
  } finally {
    client.release();
  }
}

// Minimalne escape HTML dla Telegrama (parse_mode=HTML)
function escapeHtml(str = "") {
  return String(str)
    .replace(/&/g, "&amp;")
    .replace(/</g, "&lt;")
    .replace(/>/g, "&gt;");
}

function getTodayStart() {
  const now = new Date();
  return new Date(Date.UTC(now.getUTCFullYear(), now.getUTCMonth(), now.getUTCDate()));
}

function formatDateTime(val) {
  if (!val) return "n/a";
  try {
    const d = val instanceof Date ? val : new Date(val);
    return d.toISOString().replace("T", " ").slice(0, 19);
  } catch {
    return "n/a";
  }
}

async function tgApi(method, payload) {
  const url = `https://api.telegram.org/bot${TG}/${method}`;
  const res = await fetch(url, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify(payload),
  });
  return res.json().catch(() => ({}));
}

async function tgSend(chatId, text, extra = {}) {
  const MAX_LEN = 3500; // bezpieczny margines dla Telegrama (limit ~4096)
  const full = String(text ?? "");

  const parts = [];
  if (full.length <= MAX_LEN) {
    parts.push(full);
  } else {
    let rest = full;
    while (rest.length > 0) {
      let cut = rest.lastIndexOf("\n", MAX_LEN);
      if (cut < 1000) cut = MAX_LEN; // jak nie ma sensownego \n, tnij twardo
      parts.push(rest.slice(0, cut));
      rest = rest.slice(cut);
    }
  }

  for (let i = 0; i < parts.length; i++) {
    const part = parts[i];
    const extraForThis = i === 0 ? extra : {}; // nie duplikuj klawiatur/markupÃ³w
    try {
      const res = await tgApi("sendMessage", {
        chat_id: chatId,
        text: part,
        parse_mode: "HTML",
        disable_web_page_preview: true,
        ...extraForThis,
      });

      if (!res || res.ok !== true) {
        console.error("Telegram send failed:", res?.description || res);
        console.error("chatId=", chatId, "textLen=", String(part).length);
      } else {
        console.log("Telegram sent:", res.result?.message_id, "chatId=", chatId, "len=", String(part).length);
      }
    } catch (err) {
      console.error("Telegram send error:", err.message || err);
    }
  }
}

async function tgAnswerCb(callbackQueryId, text, showAlert = false) {
  try {
    await tgApi("answerCallbackQuery", {
      callback_query_id: callbackQueryId,
      text,
      show_alert: !!showAlert,
    });
  } catch (e) {
    // ignore
  }
}

// ---------- mapowanie Telegram ID -> user_id (aliasy) ----------

async function resolveUserIdFromTg(tgId) {
  const tid = String(tgId);

  // standard: pobieramy user po telegram_id
  const user = await getUserWithPlanByTelegramId(tid);
  return user?.id || null;
}

// jeÅ›li nie ma chat_notifications â€“ tworzymy domyÅ›lnie WÅÄ„CZONE + single
async function ensureChatNotificationsRow(chatId, userId) {
  await dbQuery(
    `
    INSERT INTO chat_notifications (chat_id, user_id, enabled, mode, daily_count, daily_count_date, created_at, updated_at)
    VALUES ($1, $2, TRUE, 'single', 0, CURRENT_DATE, NOW(), NOW())
    ON CONFLICT (chat_id, user_id) DO NOTHING
    `,
    [String(chatId), Number(userId)]
  );
}

async function fetchChatNotifyFrom(chatId, userId) {
  try {
    const res = await dbQuery(
      `SELECT notify_from FROM chat_notifications WHERE chat_id = $1 AND user_id = $2 LIMIT 1`,
      [String(chatId), Number(userId)]
    );
    const raw = res.rows[0]?.notify_from;
    return raw ? new Date(raw) : new Date(0);
  } catch {
    return new Date(0);
  }
}

async function fetchLinkNotifyFrom(linkId, userId) {
  try {
    const res = await dbQuery(
      `SELECT notify_from FROM links WHERE id = $1 AND user_id = $2 LIMIT 1`,
      [Number(linkId), Number(userId)]
    );
    const raw = res.rows[0]?.notify_from;
    return raw ? new Date(raw) : new Date(0);
  } catch {
    return new Date(0);
  }
}

// ---------- long polling z getUpdates ----------

let offset = 0;

async function fetchUpdates() {
  const url = new URL(`https://api.telegram.org/bot${TG}/getUpdates`);
  url.searchParams.set("timeout", "30");
  if (offset) url.searchParams.set("offset", String(offset));

  const res = await fetch(url.href);
  if (!res.ok) throw new Error(`getUpdates HTTP ${res.status}`);

  const data = await res.json();
  if (!data.ok) throw new Error(`getUpdates Telegram error: ${data.description}`);

  return data.result;
}

// ---------- pomocnik do budowy STATUS ----------

const STATUS_I18N = (() => {
  const pl = {
    title: "â„¹ï¸ Status bota",
    plan: (name, expStr, addons) => {
      const line = `Plan: ${name} (do ${expStr})`;
      return addons > 0 ? `${line}\nDodatki (addon +10): ${addons}` : line;
    },
    linksEnabled: (enabled, limit) => `Aktywne wyszukiwania (wÅ‚Ä…czone): ${enabled}/${limit}`,
    linksTotal: (total, limit) => `ÅÄ…cznie wyszukiwaÅ„ (w bazie): ${total}/${limit}`,
    totalOffers: (limit) => `ÅÄ…czny limit ofert (zgodnie z planem): ${limit}`,
    changeLine: "Zmiana: /on /off /pojedyncze /zbiorcze",
    dailyLimit: (limit) => `Limit dziennych powiadomieÅ„: ${limit}`,
    chatLine: (enabled, mode, daily, limit) => {
      const status = enabled ? "âœ… Powiadomienia WÅÄ„CZONE" : "â›” Powiadomienia WYÅÄ„CZONE";
      const modeText = mode === "batch" ? "zbiorczo" : mode === "off" ? "wyÅ‚Ä…czone" : "pojedynczo";
      const dailyText = `Dzisiejsze powiadomienia: ${daily}/${limit}`;
      return `${status}\nTryb domyÅ›lny na tym czacie: ${modeText}\n${dailyText}`;
    },
    quietOn: (from, to) => `Cisza nocna: wÅ‚Ä…czona (${from}:00â€“${to}:00)`,
    quietOff: "Cisza nocna: wyÅ‚Ä…czona",
    perLinkHint: "Per link: /pojedyncze_ID /zbiorcze_ID /off_ID /on_ID",
    noLinks: "Brak aktywnych wyszukiwaÅ„.",
    linksHeader: "Wszystkie wyszukiwania:",
    unknown: "(bÅ‚Ä…d)",
    modeLabel: (m) => (m === "batch" ? "tryb: zbiorczo" : m === "off" ? "tryb: wyÅ‚Ä…czone" : "tryb: pojedynczo"),
  };

  const en = {
    title: "â„¹ï¸ Bot Status",
    plan: (name, expStr, addons) => {
      const line = `Plan: ${name} (until ${expStr})`;
      return addons > 0 ? `${line}\nAddons (+10 links each): ${addons}` : line;
    },
    linksEnabled: (enabled, limit) => `Active searches (enabled): ${enabled}/${limit}`,
    linksTotal: (total, limit) => `Total searches (in database): ${total}/${limit}`,
    totalOffers: (limit) => `Total offers limit (per plan): ${limit}`,
    changeLine: "Change: /on /off /single /batch",
    dailyLimit: (limit) => `Daily notification limit: ${limit}`,
    chatLine: (enabled, mode, daily, limit) => {
      const status = enabled ? "âœ… Notifications ENABLED" : "â›” Notifications DISABLED";
      const modeText = mode === "batch" ? "batch" : mode === "off" ? "disabled" : "single";
      const dailyText = `Today's notifications: ${daily}/${limit}`;
      return `${status}\nDefault mode for this chat: ${modeText}\n${dailyText}`;
    },
    quietOn: (from, to) => `Quiet hours: enabled (${from}:00â€“${to}:00)`,
    quietOff: "Quiet hours: disabled",
    perLinkHint: "Per link: /single_ID /batch_ID /off_ID /on_ID",
    noLinks: "No active searches.",
    linksHeader: "Active searches:",
    unknown: "(error)",
    modeLabel: (m) => (m === "batch" ? "mode: batch" : m === "off" ? "mode: disabled" : "mode: single"),
  };

  const de = {
    title: "â„¹ï¸ Bot-Status",
    plan: (name, expStr, addons) => {
      const line = `Plan: ${name} (bis ${expStr})`;
      return addons > 0 ? `${line}\nErweiterungen (+10 Links je): ${addons}` : line;
    },
    linksEnabled: (enabled, limit) => `Aktive Suchen (aktiviert): ${enabled}/${limit}`,
    linksTotal: (total, limit) => `Suchen gesamt (in Datenbank): ${total}/${limit}`,
    totalOffers: (limit) => `Gesamtlimit fÃ¼r Angebote (pro Plan): ${limit}`,
    changeLine: "Ã„ndern: /on /off /single /batch",
    dailyLimit: (limit) => `TÃ¤gliches Benachrichtigungslimit: ${limit}`,
    chatLine: (enabled, mode, daily, limit) => {
      const status = enabled ? "âœ… Benachrichtigungen AKTIVIERT" : "â›” Benachrichtigungen DEAKTIVIERT";
      const modeText = mode === "batch" ? "Batch" : mode === "off" ? "deaktiviert" : "einzeln";
      const dailyText = `Heutige Benachrichtigungen: ${daily}/${limit}`;
      return `${status}\nStandardmodus fÃ¼r diesen Chat: ${modeText}\n${dailyText}`;
    },
    quietOn: (from, to) => `Ruhestunden: aktiviert (${from}:00â€“${to}:00)`,
    quietOff: "Ruhestunden: deaktiviert",
    perLinkHint: "Befehle: /on /off /single /batch\nPro Link: /single_ID /batch_ID /off_ID /on_ID",
    noLinks: "Keine aktiven Suchen.",
    linksHeader: "Suchliste:",
    unknown: "(Fehler)",
    modeLabel: (m) => (m === "batch" ? "Modus: Batch" : m === "off" ? "Modus: deaktiviert" : "Modus: einzeln"),
  };

  const fr = {
    title: "â„¹ï¸ Statut du bot",
    plan: (name, expStr, addons) => {
      const line = `Plan: ${name} (jusqu'au ${expStr})`;
      return addons > 0 ? `${line}\nExtensions (+10 liens chacune): ${addons}` : line;
    },
    linksEnabled: (enabled, limit) => `Recherches actives (activÃ©es): ${enabled}/${limit}`,
    linksTotal: (total, limit) => `Total des recherches (en base): ${total}/${limit}`,
    totalOffers: (limit) => `Limite totale d'offres (par plan): ${limit}`,
    changeLine: "Changer: /on /off /single /batch",
    dailyLimit: (limit) => `Limite quotidienne de notifications: ${limit}`,
    chatLine: (enabled, mode, daily, limit) => {
      const status = enabled ? "âœ… Notifications ACTIVÃ‰ES" : "â›” Notifications DÃ‰SACTIVÃ‰ES";
      const modeText = mode === "batch" ? "groupÃ©" : mode === "off" ? "dÃ©sactivÃ©" : "unique";
      const dailyText = `Notifications aujourd'hui: ${daily}/${limit}`;
      return `${status}\nMode par dÃ©faut pour ce chat: ${modeText}\n${dailyText}`;
    },
    quietOn: (from, to) => `Heures silencieuses: activÃ©es (${from}:00â€“${to}:00)`,
    quietOff: "Heures silencieuses: dÃ©sactivÃ©es",
    perLinkHint: "Commandes: /on /off /single /batch\nPar lien: /single_ID /batch_ID /off_ID /on_ID",
    noLinks: "Aucune recherche active.",
    linksHeader: "Liste des recherches:",
    unknown: "(erreur)",
    modeLabel: (m) => (m === "batch" ? "mode: groupÃ©" : m === "off" ? "mode: dÃ©sactivÃ©" : "mode: unique"),
  };

  const es = {
    title: "â„¹ï¸ Estado del bot",
    plan: (name, expStr, addons) => {
      const line = `Plan: ${name} (hasta ${expStr})`;
      return addons > 0 ? `${line}\nComplementos (+10 enlaces cada uno): ${addons}` : line;
    },
    linksEnabled: (enabled, limit) => `BÃºsquedas activas (habilitadas): ${enabled}/${limit}`,
    linksTotal: (total, limit) => `Total de bÃºsquedas (en base de datos): ${total}/${limit}`,
    totalOffers: (limit) => `LÃ­mite total de ofertas (por plan): ${limit}`,
    changeLine: "Cambiar: /on /off /single /batch",
    dailyLimit: (limit) => `LÃ­mite diario de notificaciones: ${limit}`,
    chatLine: (enabled, mode, daily, limit) => {
      const status = enabled ? "âœ… Notificaciones HABILITADAS" : "â›” Notificaciones DESHABILITADAS";
      const modeText = mode === "batch" ? "agrupado" : mode === "off" ? "deshabilitado" : "Ãºnico";
      const dailyText = `Notificaciones hoy: ${daily}/${limit}`;
      return `${status}\nModo predeterminado para este chat: ${modeText}\n${dailyText}`;
    },
    quietOn: (from, to) => `Horas de silencio: habilitadas (${from}:00â€“${to}:00)`,
    quietOff: "Horas de silencio: deshabilitadas",
    perLinkHint: "Comandos: /on /off /single /batch\nPor enlace: /single_ID /batch_ID /off_ID /on_ID",
    noLinks: "No hay bÃºsquedas activas.",
    linksHeader: "Lista de bÃºsquedas:",
    unknown: "(error)",
    modeLabel: (m) => (m === "batch" ? "modo: agrupado" : m === "off" ? "modo: deshabilitado" : "modo: Ãºnico"),
  };

  const sk = {
    title: "â„¹ï¸ Stav bota",
    plan: (name, expStr, addons) => {
      const line = `Plan: ${name} (do ${expStr})`;
      return addons > 0 ? `${line}\nDoplnky (+10 liniek kaÅ¾dÃ½): ${addons}` : line;
    },
    linksEnabled: (enabled, limit) => `AktÃ­vne vyhÄ¾adÃ¡vania (zapnutÃ©): ${enabled}/${limit}`,
    linksTotal: (total, limit) => `VyhÄ¾adÃ¡vania spolu (v databÃ¡ze): ${total}/${limit}`,
    totalOffers: (limit) => `CelkovÃ½ limit ponÃºk (podÄ¾a plÃ¡nu): ${limit}`,
    changeLine: "Zmena: /on /off /single /batch",
    dailyLimit: (limit) => `DennÃ½ limit notifikÃ¡ciÃ­: ${limit}`,
    chatLine: (enabled, mode, daily, limit) => {
      const status = enabled ? "âœ… NotifikÃ¡cie ZAPNUTÃ‰" : "â›” NotifikÃ¡cie VYPNUTÃ‰";
      const modeText = mode === "batch" ? "hromadne" : mode === "off" ? "vypnutÃ©" : "jednotlivo";
      const dailyText = `DneÅ¡nÃ© notifikÃ¡cie: ${daily}/${limit}`;
      return `${status}\nPredvolenÃ½ reÅ¾im pre tento chat: ${modeText}\n${dailyText}`;
    },
    quietOn: (from, to) => `TichÃ½ reÅ¾im: zapnutÃ½ (${from}:00â€“${to}:00)`,
    quietOff: "TichÃ½ reÅ¾im: vypnutÃ½",
    perLinkHint: "Na link: /single_ID /batch_ID /off_ID /on_ID",
    noLinks: "Å½iadne aktÃ­vne vyhÄ¾adÃ¡vania.",
    linksHeader: "AktÃ­vne vyhÄ¾adÃ¡vania:",
    unknown: "(chyba)",
    modeLabel: (m) => (m === "batch" ? "reÅ¾im: hromadne" : m === "off" ? "reÅ¾im: vypnutÃ©" : "reÅ¾im: jednotlivo"),
  };

  return {
    pl,
    en,
    de,
    fr,
    es,
    it: en, // fallback to EN for remaining languages
    pt: en,
    ru: en,
    cs: en,
    hu: en,
    sk
  };
})();

function normalizeLangCode(lang) {
  const v = String(lang || "").toLowerCase();
  const code = v.split("-")[0];
  return STATUS_I18N[code] ? code : "en";
}

function formatDateYMD(dateVal) {
  if (!dateVal) return "n/a";
  try {
    const d = dateVal instanceof Date ? dateVal : new Date(dateVal);
    return d.toISOString().slice(0, 10);
  } catch {
    return "n/a";
  }
}

async function buildStatusMessage(chatId, user) {
  const userId = user.id;
  // Prefer language_code first because DB trigger restricts lang to pl/en
  const lang = normalizeLangCode(user.language_code || user.lang || user.language || "en");
  const t = STATUS_I18N[lang] || STATUS_I18N.en;
  const todayStr = new Date().toISOString().slice(0, 10);

  const linkLimit = Number(user.links_limit_total ?? getEffectiveLinkLimit(user) ?? 0) || 0;
  const dailyLimit = Number(user.daily_notifications_limit ?? MAX_DAILY_NOTIFICATIONS) || MAX_DAILY_NOTIFICATIONS;
  const totalOffersLimit = Number(user.history_limit_total ?? (getPerLinkItemLimit(user) * linkLimit) ?? 0) || 0;
  const planCode = user.plan_code || user.plan_name || "-";
  const planName = user.plan_name || user.plan_code || "-";
  const planExp = formatDateYMD(user.plan_expires_at || user.expires_at);
  
  // Calculate addon packs (if platinum)
  const extraPacks = planCode.toLowerCase() === "platinum" ? getExtraLinkPacks(user) : 0;

  // stderr is always unbuffered in Node.js, unlike stdout in non-TTY environments
  process.stderr.write(
    `[status_debug] user_id=${userId} lang=${lang} plan_code=${planCode} link_limit=${linkLimit} daily_limit=${dailyLimit} total_offers_limit=${totalOffersLimit} source=entitlements.history_limit_total lang_col=${user.lang} lang_code=${user.language_code}\n`
  );

  let text = `${t.title}\n\n`;
  text += `${t.plan(planName, planExp, extraPacks)}\n\n`;

  // Link counters
  try {
    const totalLinks = await countActiveLinksForUserId(userId);
    const enabledLinks = await countEnabledLinksForUserId(userId);
    text += `${t.linksEnabled(enabledLinks, linkLimit)}\n`;
    text += `${t.linksTotal(totalLinks, linkLimit)}\n`;
    if (totalOffersLimit) {
      text += `${t.totalOffers(totalOffersLimit)}\n`;
    }
    if (dailyLimit) {
      text += `${t.dailyLimit(dailyLimit)}\n`;
    }
    text += `\n${t.changeLine}\n\n`;
  } catch (e) {
    console.error("buildStatusMessage: link counters error", e);
  }

  // Chat notification settings
  let chatDefaultMode = "single";
  let chatEnabled = true;
  try {
    const res = await dbQuery(
      `
      SELECT enabled, mode, daily_count, daily_count_date
      FROM chat_notifications
      WHERE chat_id = $1 AND user_id = $2
      `,
      [String(chatId), userId]
    );

    if (res.rowCount) {
      const row = res.rows[0];
      const enabled = row.enabled !== false;
      chatEnabled = enabled;
      const mode = (row.mode || "single").toLowerCase();
      chatDefaultMode = mode;

      let daily = 0;
      try {
        const dr = await dbQuery(
          `SELECT COUNT(*)::int AS cnt FROM sent_offers WHERE chat_id = $1 AND user_id = $2 AND sent_at >= $3`,
          [String(chatId), userId, getTodayStart()]
        );
        daily = dr.rows[0]?.cnt ?? 0;
      } catch (e) {
        console.error("buildStatusMessage: sent_offers daily error", e);
        let fallback = row.daily_count || 0;
        let dateStr = null;
        if (row.daily_count_date) {
          dateStr = row.daily_count_date.toISOString
            ? row.daily_count_date.toISOString().slice(0, 10)
            : String(row.daily_count_date).slice(0, 10);
        }
        if (dateStr !== todayStr) fallback = 0;
        daily = fallback;
      }

      const modeLabel = mode === "batch" ? "batch" : mode === "off" ? "off" : "single";
      text += `${t.chatLine(enabled, modeLabel, daily, dailyLimit)}\n\n`;
    } else {
      text += `${t.chatLine(true, "single", 0, dailyLimit)}\n\n`;
    }
  } catch (e) {
    console.error("buildStatusMessage: chat_notifications error", e);
    text += `${t.unknown}\n\n`;
  }

  // Quiet hours
  try {
    const qh = await getQuietHours(String(chatId));
    if (qh && qh.quiet_enabled) {
      text += `${t.quietOn(qh.quiet_from ?? 22, qh.quiet_to ?? 7)}\n\n`;
    } else {
      text += `${t.quietOff}\n\n`;
    }
  } catch (e) {
    console.error("buildStatusMessage: quiet_hours error", e);
    text += `${t.unknown}\n\n`;
  }

  // Links list (up to 25)
  try {
    const resLinks = await dbQuery(
      `
      SELECT
        l.id,
        l.name,
        l.url,
        l.source,
        l.active,
        lnm.mode AS link_mode
      FROM links l
      LEFT JOIN link_notification_modes lnm
        ON lnm.user_id = l.user_id
       AND lnm.chat_id = $2
       AND lnm.link_id = l.id
      WHERE l.user_id = $1
        AND l.active = TRUE
      ORDER BY l.id ASC
      LIMIT 25
      `,
      [userId, String(chatId)]
    );

    if (!resLinks.rowCount) {
      text += `${t.noLinks}`;
    } else {
      text += `${t.linksHeader}\n`;
      for (const row of resLinks.rows) {
        const src = (row.source || "").toUpperCase() || "LINK";
        const name = row.name || row.url;
        const lm = row.link_mode == null ? null : String(row.link_mode).toLowerCase();
        const mode =
          lm === null
            ? chatDefaultMode
            : lm === "batch"
            ? "batch"
            : lm === "off"
            ? "off"
            : "single";

        const state = (mode === "off" || !row.active) ? "â›”" : "âœ…";
        const bell = chatEnabled && mode !== "off" ? "ğŸ””" : "";
        const modeText = t.modeLabel(mode);
        text += `â€¢ ${state}${bell ? bell : ""} ${row.id} â€“ ${escapeHtml(name)} (${src}) â€“ ${modeText}\n`;
      }

      text += `\n${t.perLinkHint}`;
    }
  } catch (e) {
    console.error("buildStatusMessage: links error", e);
    text += `${t.unknown}`;
  }

  return text.trim();
}

// ---------- /help /start ----------

async function handleHelp(msg) {
  const chatId = msg.chat.id;

  const text =
    "ğŸ‘‹ CzeÅ›Ä‡! To bot FindYourDeal.\n\n" +
    "Podstawowe komendy:\n" +
    "/lista â€“ pokaÅ¼ Twoje aktywne monitorowane linki\n" +
    "/usun &lt;ID&gt; â€“ wyÅ‚Ä…cz monitorowanie linku o ID\n" +
    "/dodaj &lt;url&gt; [nazwa] â€“ dodaj nowy link do monitorowania\n" +
    "/status â€“ status bota, planu i powiadomieÅ„\n\n" +
    "Powiadomienia PUSH na tym czacie:\n" +
    "/on â€“ wÅ‚Ä…cz\n" +
    "/off â€“ wyÅ‚Ä…cz\n" +
    "/pojedyncze â€“ pojedyncze karty\n" +
    "/zbiorcze â€“ zbiorcza lista\n\n" +
    "Tryb per-link (TYLKO na tym czacie):\n" +
    "/pojedyncze_ID, /zbiorcze_ID, /off_ID (np. /zbiorcze_18)\n\n" +
    "Cisza nocna:\n" +
    "/cisza â€“ pokaÅ¼\n" +
    "/cisza HH-HH â€“ ustaw (np. /cisza 22-7)\n" +
    "/cisza_off â€“ wyÅ‚Ä…cz\n\n" +
    "Historia wysÅ‚anych:\n" +
    "/najnowsze â€“ najnowsze wysÅ‚ane na tym czacie\n" +
    "/najnowsze &lt;ID&gt; â€“ najnowsze wysÅ‚ane dla linku\n" +
    "/najtansze â€“ najtaÅ„sze wysÅ‚ane na tym czacie\n" +
    "/najtansze &lt;ID&gt; â€“ najtaÅ„sze wysÅ‚ane dla linku\n\n" +
    "PrzykÅ‚ady:\n" +
    "<code>/lista</code>\n" +
    "<code>/usun 18</code>\n" +
    "<code>/dodaj https://www.olx.pl/oferty/?q=iphone14 iPhone 14 OLX</code>\n" +
    "<code>/najnowsze</code>";

  await tgSend(chatId, text);
}

// ---------- /lista ----------

async function handleLista(msg, user) {
  const chatId = msg.chat.id;

  try {
    const links = await getLinksByUserId(user.id, true);

    if (!links.length) {
      await tgSend(chatId, "Nie masz jeszcze Å¼adnych linkÃ³w Å‚Ä…cznie.");
      return;
    }

    let text = "ğŸ“‹ Aktywne monitorowane linki:\n\n";
    for (const row of links) {
      text += `ID <b>${row.id}</b> â€” ${escapeHtml(row.name || "(bez nazwy)")}\n`;
      text += `<code>${escapeHtml(row.url)}</code>\n\n`;
    }
    text += "WyÅ‚Ä…cz: <code>/usun ID</code>\nnp. <code>/usun 18</code>";

    await tgSend(chatId, text);
  } catch (err) {
    console.error("handleLista error:", err);
    await tgSend(chatId, "âŒ BÅ‚Ä…d przy pobieraniu listy linkÃ³w.");
  }
}

// ---------- /usun ----------

async function handleUsun(msg, user, argText) {
  const chatId = msg.chat.id;
  const id = parseInt(argText, 10);

  if (!id) {
    await tgSend(chatId, "Podaj ID linku, np.:\n<code>/usun 18</code>");
    return;
  }

  try {
    const row = await deactivateLinkForUserId(id, user.id);

    if (!row) {
      await tgSend(
        chatId,
        `Nie znalazÅ‚em linku o ID <b>${id}</b> na Twoim koncie. UÅ¼yj /lista.`
      );
      return;
    }

    let text = "âœ… WyÅ‚Ä…czyÅ‚em monitorowanie linku:\n\n";
    text += `ID <b>${row.id}</b> â€” ${escapeHtml(row.name || "(bez nazwy)")}\n`;
    text += `<code>${escapeHtml(row.url)}</code>\n\n`;
    text += "MoÅ¼esz go wÅ‚Ä…czyÄ‡ ponownie w panelu albo dodaÄ‡ ponownie jako nowe monitorowanie.";

    await tgSend(chatId, text);
  } catch (err) {
    console.error("handleUsun error:", err);
    await tgSend(chatId, "âŒ BÅ‚Ä…d przy wyÅ‚Ä…czaniu linku.");
  }
}

// ---------- /dodaj ----------

async function handleDodaj(msg, user, argText) {
  const chatId = msg.chat.id;

  if (!argText) {
    await tgSend(
      chatId,
      "UÅ¼ycie:\n<code>/dodaj &lt;url&gt; [nazwa]</code>\n\n" +
        "PrzykÅ‚ad:\n" +
        "<code>/dodaj https://www.olx.pl/oferty/?q=iphone14 iPhone 14 OLX</code>"
    );
    return;
  }

  const parts = argText.split(/\s+/);
  const url = parts[0];
  const name = parts.slice(1).join(" ") || null;

  if (!url || !/^https?:\/\//i.test(url)) {
    await tgSend(
      chatId,
      "Pierwszy parametr musi byÄ‡ poprawnym URL, np.:\n" +
        "<code>/dodaj https://www.olx.pl/oferty/?q=iphone14 iPhone 14 OLX</code>"
    );
    return;
  }

  // plan aktywny?
  const activePlan = isPlanActive(user, new Date());
  if (!activePlan) {
    // Trial wygasÅ‚
    if (String(user.plan_name || "").toLowerCase() === "trial" && user.trial_used) {
      await tgSend(
        chatId,
        [
          "â° TwÃ³j plan Trial wygasÅ‚.",
          "Monitoring w Trial jest juÅ¼ niedostÄ™pny.",
          "",
          "Aby dalej korzystaÄ‡ z bota, wybierz plan pÅ‚atny (Starter / Growth / Platinum).",
        ].join("\n")
      );
      return;
    }

    // plan pÅ‚atny wygasÅ‚
    const pn = String(user.plan_name || "").toLowerCase();
    if (pn === "starter" || pn === "growth" || pn === "platinum") {
      await tgSend(
        chatId,
        [
          "â° TwÃ³j plan wygasÅ‚.",
          "Aby dodaÄ‡ nowe linki i wznowiÄ‡ monitoring, przedÅ‚uÅ¼ plan w panelu klienta.",
        ].join("\n")
      );
      return;
    }

    await tgSend(
      chatId,
      [
        "Nie masz aktywnego planu z monitoringiem linkÃ³w.",
        user.trial_used
          ? "Trial zostaÅ‚ juÅ¼ wykorzystany. Wykup plan Starter / Growth / Platinum."
          : "MoÅ¼esz uruchomiÄ‡ jednorazowo Trial (3 dni / 5 linkÃ³w) albo wybraÄ‡ plan Starter / Growth / Platinum.",
      ].join("\n")
    );
    return;
  }

  // limit linkÃ³w
  const activeLinks = await countActiveLinksForUserId(user.id);
  const limit = getEffectiveLinkLimit(user);

  if (activeLinks >= limit) {
    const msgText = buildLimitReachedMessage(user, activeLinks, limit);
    await tgSend(chatId, escapeHtml(msgText));
    return;
  }

  try {
    const row = await insertLinkForUserId(user.id, name, url);

    await tgSend(
      chatId,
      [
        "âœ… DodaÅ‚em nowy link do monitorowania:",
        "",
        `ID <b>${row.id}</b> â€” ${escapeHtml(row.name || "(bez nazwy)")}`,
        `<code>${escapeHtml(row.url)}</code>`,
        "",
        `Aktywne linki: ${activeLinks + 1}/${limit}`,
        "",
        "Linki sprawdzisz komendÄ…: <code>/lista</code>",
      ].join("\n")
    );
  } catch (err) {
    console.error("handleDodaj error:", err);
    await tgSend(chatId, "âŒ BÅ‚Ä…d przy dodawaniu linku.");
  }
}

// ---------- /status ----------

async function handleStatus(msg, user) {
  const chatId = String(msg.chat.id);

  try {
    await ensureChatNotificationsRow(chatId, user.id);
    const statusText = await buildStatusMessage(chatId, user);
    await tgSend(chatId, statusText);
  } catch (err) {
    console.error("handleStatus error:", err);
    await tgSend(chatId, "âŒ BÅ‚Ä…d przy pobieraniu statusu.");
  }
}

// ---------- /on /off ----------

async function handleNotificationsOn(msg, user) {
  const chatId = String(msg.chat.id);
  const lang = getUserLang(user);
  const t = CMD_I18N[lang] || CMD_I18N.en;

  await ensureChatNotificationsRow(chatId, user.id);

  await dbQuery(
    `
    INSERT INTO chat_notifications (chat_id, user_id, enabled, mode, updated_at)
    VALUES ($1, $2, TRUE, 'single', NOW())
    ON CONFLICT (chat_id, user_id) DO UPDATE SET
      enabled = TRUE,
      updated_at = NOW()
    `,
    [chatId, user.id]
  );

  await tgSend(chatId, t.notifOn);
}

async function handleNotificationsOff(msg, user) {
  const chatId = String(msg.chat.id);
  const lang = getUserLang(user);
  const t = CMD_I18N[lang] || CMD_I18N.en;

  await ensureChatNotificationsRow(chatId, user.id);

  await dbQuery(
    `
    INSERT INTO chat_notifications (chat_id, user_id, enabled, mode, updated_at)
    VALUES ($1, $2, FALSE, 'single', NOW())
    ON CONFLICT (chat_id, user_id) DO UPDATE SET
      enabled = FALSE,
      updated_at = NOW()
    `,
    [chatId, user.id]
  );

  await tgSend(chatId, t.notifOff);
}

// ---------- /pojedyncze /zbiorcze (domyÅ›lny tryb czatu) ----------

async function handleModeSingle(msg, user) {
  const chatId = String(msg.chat.id);
  const lang = getUserLang(user);
  const t = CMD_I18N[lang] || CMD_I18N.en;

  await ensureChatNotificationsRow(chatId, user.id);

  await dbQuery(
    `
    UPDATE chat_notifications
    SET mode = 'single', updated_at = NOW()
    WHERE chat_id = $1 AND user_id = $2
    `,
    [chatId, user.id]
  );

  await tgSend(chatId, t.modeSingle);
}

async function handleModeBatch(msg, user) {
  const chatId = String(msg.chat.id);
  const lang = getUserLang(user);
  const t = CMD_I18N[lang] || CMD_I18N.en;

  await ensureChatNotificationsRow(chatId, user.id);

  await dbQuery(
    `
    UPDATE chat_notifications
    SET mode = 'batch', updated_at = NOW()
    WHERE chat_id = $1 AND user_id = $2
    `,
    [chatId, user.id]
  );

  await tgSend(chatId, t.modeBatch);
}

// ---------- tryb per-link na tym czacie ----------

async function setPerLinkMode(chatId, userId, linkId, mode) {
  const m = String(mode || "").toLowerCase();
  const finalMode = m === "batch" ? "batch" : m === "off" ? "off" : "single";

  // zabezpieczenie: link musi naleÅ¼eÄ‡ do usera
  const chk = await dbQuery(
    `SELECT id FROM links WHERE id = $1 AND user_id = $2 LIMIT 1`,
    [Number(linkId), Number(userId)]
  );
  if (!chk.rowCount) return { ok: false, reason: "Link nie naleÅ¼y do Twojego konta." };

  await dbQuery(
    `
    INSERT INTO link_notification_modes (user_id, chat_id, link_id, mode, updated_at)
    VALUES ($1, $2, $3, $4, NOW())
    ON CONFLICT (user_id, chat_id, link_id) DO UPDATE SET
      mode = EXCLUDED.mode,
      updated_at = NOW()
    `,
    [Number(userId), String(chatId), Number(linkId), finalMode]
  );

  return { ok: true, mode: finalMode };
}

// ---------- /lang - zmiana jÄ™zyka ----------

// Ordered list of supported languages (for consistent display in /lang)
const LANG_CODES = ["en", "pl", "de", "fr", "it", "es", "pt", "ru", "cs", "hu", "sk"];

const SUPPORTED_LANGS = {
  "en": "English ğŸ‡¬ğŸ‡§",
  "pl": "Polski ğŸ‡µğŸ‡±",
  "de": "Deutsch ğŸ‡©ğŸ‡ª",
  "fr": "FranÃ§ais ğŸ‡«ğŸ‡·",
  "it": "Italiano ğŸ‡®ğŸ‡¹",
  "es": "EspaÃ±ol ğŸ‡ªğŸ‡¸",
  "pt": "PortuguÃªs ğŸ‡µğŸ‡¹",
  "ru": "Ğ ÑƒÑÑĞºĞ¸Ğ¹ ğŸ‡·ğŸ‡º",
  "cs": "ÄŒeÅ¡tina ğŸ‡¨ğŸ‡¿",
  "hu": "Magyar ğŸ‡­ğŸ‡º",
  "sk": "SlovenÄina ğŸ‡¸ğŸ‡°"
};

// Confirmation templates per target language
const LANG_CONFIRM = {
  en: (name) => `âœ… Language changed to: <b>${name}</b>`,
  pl: (name) => `âœ… JÄ™zyk zmieniony na: <b>${name}</b>`,
  de: (name) => `âœ… Sprache geÃ¤ndert zu: <b>${name}</b>`,
  fr: (name) => `âœ… Langue changÃ©e en : <b>${name}</b>`,
  it: (name) => `âœ… Lingua cambiata in: <b>${name}</b>`,
  es: (name) => `âœ… Idioma cambiado a: <b>${name}</b>`,
  pt: (name) => `âœ… Idioma alterado para: <b>${name}</b>`,
  ru: (name) => `âœ… Ğ¯Ğ·Ñ‹Ğº Ğ¸Ğ·Ğ¼ĞµĞ½Ñ‘Ğ½ Ğ½Ğ°: <b>${name}</b>`,
  cs: (name) => `âœ… Jazyk zmÄ›nÄ›n na: <b>${name}</b>`,
  hu: (name) => `âœ… Nyelv mÃ³dosÃ­tva erre: <b>${name}</b>`,
  sk: (name) => `âœ… Jazyk zmenenÃ½ na: <b>${name}</b>`
};

// TÅ‚umaczenia dla /lang komend
const LANG_I18N = {
  en: {
    currentLanguage: "ğŸŒ Current language: ",
    available: "Available languages:",
    unknown: "âŒ Unknown language. Supported: "
  },
  pl: {
    currentLanguage: "ğŸŒ Obecny jÄ™zyk: ",
    available: "DostÄ™pne jÄ™zyki:",
    unknown: "âŒ Nieznany jÄ™zyk. ObsÅ‚ugiwane: "
  },
  de: {
    currentLanguage: "ğŸŒ Aktuelle Sprache: ",
    available: "VerfÃ¼gbare Sprachen:",
    unknown: "âŒ Unbekannte Sprache. UnterstÃ¼tzt: "
  },
  fr: {
    currentLanguage: "ğŸŒ Langue actuelle : ",
    available: "Langues disponibles :",
    unknown: "âŒ Langue inconnue. SupportÃ©es : "
  },
  it: {
    currentLanguage: "ğŸŒ Lingua attuale: ",
    available: "Lingue disponibili:",
    unknown: "âŒ Lingua sconosciuta. Supportate: "
  },
  es: {
    currentLanguage: "ğŸŒ Idioma actual: ",
    available: "Idiomas disponibles:",
    unknown: "âŒ Idioma desconocido. Soportados: "
  },
  pt: {
    currentLanguage: "ğŸŒ Idioma atual: ",
    available: "Idiomas disponÃ­veis:",
    unknown: "âŒ Idioma desconhecido. Suportados: "
  },
  ru: {
    currentLanguage: "ğŸŒ Ğ¢ĞµĞºÑƒÑ‰Ğ¸Ğ¹ ÑĞ·Ñ‹Ğº: ",
    available: "Ğ”Ğ¾ÑÑ‚ÑƒĞ¿Ğ½Ñ‹Ğµ ÑĞ·Ñ‹ĞºĞ¸:",
    unknown: "âŒ ĞĞµĞ¸Ğ·Ğ²ĞµÑÑ‚Ğ½Ñ‹Ğ¹ ÑĞ·Ñ‹Ğº. ĞŸĞ¾Ğ´Ğ´ĞµÑ€Ğ¶Ğ¸Ğ²Ğ°ĞµĞ¼Ñ‹Ğµ: "
  },
  cs: {
    currentLanguage: "ğŸŒ SouÄasnÃ½ jazyk: ",
    available: "DostupnÃ© jazyky:",
    unknown: "âŒ NeznÃ¡mÃ½ jazyk. PodporovanÃ©: "
  },
  hu: {
    currentLanguage: "ğŸŒ Jelenlegi nyelv: ",
    available: "ElÃ©rhetÅ‘ nyelvek:",
    unknown: "âŒ Ismeretlen nyelv. TÃ¡mogatott: "
  },
  sk: {
    currentLanguage: "ğŸŒ AktuÃ¡lny jazyk: ",
    available: "DostupnÃ© jazyky:",
    unknown: "âŒ NeznÃ¡my jazyk. PodporovanÃ©: "
  }
};

const getLangConfirmTemplate = (lang) => LANG_CONFIRM[lang] || LANG_CONFIRM.en;

// Komunikaty i18n dla poleceÅ„ (ON/OFF, tryby, per-link, cisza, historia)
const CMD_I18N = {
  pl: {
    notifOn: "âœ… Powiadomienia WÅÄ„CZONE na tym czacie.",
    notifOff: "â›” Powiadomienia WYÅÄ„CZONE na tym czacie.",
    modeSingle: "ğŸ“¨ Ustawiono tryb: <b>pojedynczo</b> (domyÅ›lny na tym czacie).",
    modeBatch: "ğŸ“¦ Ustawiono tryb: <b>zbiorczo</b> (domyÅ›lny na tym czacie).",
    linkEnabled: (id, prettyMode) => `âœ… Link <b>${id}</b> na tym czacie WÅÄ„CZONY (dziedziczy tryb czatu: <b>${prettyMode}</b>).`,
    linkSet: (id, prettyMode) => `âœ… Link <b>${id}</b> na tym czacie ustawiony: <b>${prettyMode}</b>`,
    linkNotYours: (id) => `âŒ Link <b>${id}</b> nie naleÅ¼y do Twojego konta.`,
    setModeFail: (reason) => `âŒ ${reason || "Nie udaÅ‚o siÄ™ ustawiÄ‡ trybu."}`,
    quietSet: (from, to) => `ğŸŒ™ Ustawiono ciszÄ™ nocnÄ…: <b>${from}:00â€“${to}:00</b>`,
    quietOn: (from, to) => `ğŸŒ™ Cisza nocna: <b>WÅÄ„CZONA</b>, godziny ${from}:00â€“${to}:00`,
    quietOff: "ğŸŒ™ Cisza nocna: <b>WYÅÄ„CZONA</b>",
    histLatestTitle: "ğŸ§¾ Najnowsze wysÅ‚ane",
    histLatestPerLink: (linkId, linkName, since) => `ğŸ§¾ Najnowsze wysÅ‚ane (link ${linkId})\n<b>${escapeHtml(linkName || "(bez nazwy)")}</b>\nOd: ${formatDateTime(since)}`,
    histLatestGlobal: (since) => `ğŸ§¾ Najnowsze wysÅ‚ane (od ${formatDateTime(since)})`,
    histLatestNone: (since) => `Brak wysÅ‚anych ofert od ${formatDateTime(since)}.`,
    histLatestNonePerLink: (linkId, since) => `Brak wysÅ‚anych ofert dla linku <b>${linkId}</b> od ${formatDateTime(since)}.`,
    histLatestFooter: "PeÅ‚na historia:",
    histCheapestTitle: "ğŸ’° NajtaÅ„sze wysÅ‚ane",
    histCheapestPerLink: (linkId, linkName, since) => `ğŸ’° NajtaÅ„sze wysÅ‚ane (link ${linkId})\n<b>${escapeHtml(linkName || "(bez nazwy)")}</b>\nOd: ${formatDateTime(since)}`,
    histCheapestGlobal: (since) => `ğŸ’° NajtaÅ„sze wysÅ‚ane (od ${formatDateTime(since)})`,
    histCheapestNone: (since) => `Brak wysÅ‚anych ofert z cenÄ… od ${formatDateTime(since)}.`,
    histCheapestNonePerLink: (linkId, since) => `Brak wysÅ‚anych ofert z cenÄ… dla linku <b>${linkId}</b> od ${formatDateTime(since)}.`,
    histNoTitle: "(bez tytuÅ‚u)",
    histFullHistory: "PeÅ‚na historia:",
    tz_current: (tz, now) => `ğŸŒ Aktualna strefa czasowa: <b>${tz}</b>\nTeraz: ${now}`,
    tz_usage: "UÅ¼ycie: <code>/timezone [strefa|alias|reset]</code>\nPrzykÅ‚ady: <code>/timezone warsaw</code>, <code>/timezone Europe/London</code>, <code>/timezone reset</code>",
    tz_set_ok: (tz) => `âœ… Strefa czasowa ustawiona na: <b>${tz}</b>`,
    tz_reset_ok: (tz) => `âœ… Strefa czasowa zresetowana do domyÅ›lnej: <b>${tz}</b>`,
    tz_invalid: (input) => `âŒ NieprawidÅ‚owa strefa czasowa: <b>${input}</b>`,
    tz_examples: "PrzykÅ‚ady poprawne:\nâ€¢ <code>/timezone warsaw</code>\nâ€¢ <code>/timezone Europe/Berlin</code>\nâ€¢ <code>/timezone newyork</code>\nâ€¢ <code>/timezone America/Los_Angeles</code>\nâ€¢ <code>/timezone reset</code>",
    settings_title: "âš™ï¸ Ustawienia",
    settings_open_panel: (url) => `MoÅ¼esz zarzÄ…dzaÄ‡ jÄ™zykiem i strefÄ… czasowÄ… w panelu: <a href="${url}">${url}</a>`,
    settings_hint: "UÅ¼yj <code>/timezone</code> aby zmieniÄ‡ strefÄ™ w Telegramie, lub wejdÅº na stronÄ™ UstawieÅ„.",
  },
  en: {
    notifOn: "âœ… Notifications ENABLED on this chat.",
    notifOff: "â›” Notifications DISABLED on this chat.",
    modeSingle: "ğŸ“¨ Default mode set: <b>single</b> (for this chat).",
    modeBatch: "ğŸ“¦ Default mode set: <b>batch</b> (for this chat).",
    linkEnabled: (id, prettyMode) => `âœ… Link <b>${id}</b> ENABLED on this chat (inherits chat mode: <b>${prettyMode}</b>).`,
    linkSet: (id, prettyMode) => `âœ… Link <b>${id}</b> set to: <b>${prettyMode}</b> on this chat`,
    linkNotYours: (id) => `âŒ Link <b>${id}</b> does not belong to your account.`,
    setModeFail: (reason) => `âŒ ${reason || "Failed to set mode."}`,
    quietSet: (from, to) => `ğŸŒ™ Quiet hours set: <b>${from}:00â€“${to}:00</b>`,
    quietOn: (from, to) => `ğŸŒ™ Quiet hours: <b>ENABLED</b>, ${from}:00â€“${to}:00`,
    quietOff: "ğŸŒ™ Quiet hours: <b>DISABLED</b>",
    histLatestTitle: "ğŸ§¾ Latest sent",
    histLatestPerLink: (linkId, linkName, since) => `ğŸ§¾ Latest sent (link ${linkId})\n<b>${escapeHtml(linkName || "(no name)")}</b>\nSince: ${formatDateTime(since)}`,
    histLatestGlobal: (since) => `ğŸ§¾ Latest sent (since ${formatDateTime(since)})`,
    histLatestNone: (since) => `No sent offers since ${formatDateTime(since)}.`,
    histLatestNonePerLink: (linkId, since) => `No sent offers for link <b>${linkId}</b> since ${formatDateTime(since)}.`,
    histLatestFooter: "Full history:",
    histCheapestTitle: "ğŸ’° Cheapest sent",
    histCheapestPerLink: (linkId, linkName, since) => `ğŸ’° Cheapest sent (link ${linkId})\n<b>${escapeHtml(linkName || "(no name)")}</b>\nSince: ${formatDateTime(since)}`,
    histCheapestGlobal: (since) => `ğŸ’° Cheapest sent (since ${formatDateTime(since)})`,
    histCheapestNone: (since) => `No sent offers with price since ${formatDateTime(since)}.`,
    histCheapestNonePerLink: (linkId, since) => `No sent offers with price for link <b>${linkId}</b> since ${formatDateTime(since)}.`,
    histNoTitle: "(no title)",
    histFullHistory: "Full history:",
    tz_current: (tz, now) => `ğŸŒ Current timezone: <b>${tz}</b>\nNow: ${now}`,
    tz_usage: "Usage: <code>/timezone [zone|alias|reset]</code>\nExamples: <code>/timezone warsaw</code>, <code>/timezone Europe/London</code>, <code>/timezone reset</code>",
    tz_set_ok: (tz) => `âœ… Timezone set to: <b>${tz}</b>`,
    tz_reset_ok: (tz) => `âœ… Timezone reset to default: <b>${tz}</b>`,
    tz_invalid: (input) => `âŒ Invalid timezone: <b>${input}</b>`,
    tz_examples: "Valid examples:\nâ€¢ <code>/timezone warsaw</code>\nâ€¢ <code>/timezone Europe/Berlin</code>\nâ€¢ <code>/timezone newyork</code>\nâ€¢ <code>/timezone America/Los_Angeles</code>\nâ€¢ <code>/timezone reset</code>",
    settings_title: "âš™ï¸ Settings",
    settings_open_panel: (url) => `You can manage your language and timezone in the panel: <a href="${url}">${url}</a>`,
    settings_hint: "Use <code>/timezone</code> to change timezone via Telegram, or visit the Settings page.",
  },
  de: {
    notifOn: "âœ… Benachrichtigungen AKTIVIERT in diesem Chat.",
    notifOff: "â›” Benachrichtigungen DEAKTIVIERT in diesem Chat.",
    modeSingle: "ğŸ“¨ Standardmodus: <b>einzeln</b> (fÃ¼r diesen Chat).",
    modeBatch: "ğŸ“¦ Standardmodus: <b>Batch</b> (fÃ¼r diesen Chat).",
    linkEnabled: (id, prettyMode) => `âœ… Link <b>${id}</b> AKTIVIERT in diesem Chat (erbt Chat-Modus: <b>${prettyMode}</b>).`,
    linkSet: (id, prettyMode) => `âœ… Link <b>${id}</b> gesetzt auf: <b>${prettyMode}</b> in diesem Chat`,
    linkNotYours: (id) => `âŒ Link <b>${id}</b> gehÃ¶rt nicht Ihrem Konto.`,
    setModeFail: (reason) => `âŒ ${reason || "Fehler beim Setzen des Modus."}`,
    quietSet: (from, to) => `ğŸŒ™ Ruhestunden eingestellt: <b>${from}:00â€“${to}:00</b>`,
    quietOn: (from, to) => `ğŸŒ™ Ruhestunden: <b>AKTIVIERT</b>, ${from}:00â€“${to}:00`,
    quietOff: "ğŸŒ™ Ruhestunden: <b>DEAKTIVIERT</b>",
    histLatestTitle: "ğŸ§¾ Letzte gesendet",
    histLatestPerLink: (linkId, linkName, since) => `ğŸ§¾ Letzte gesendet (Link ${linkId})\n<b>${escapeHtml(linkName || "(kein Name)")}</b>\nSeit: ${formatDateTime(since)}`,
    histLatestGlobal: (since) => `ğŸ§¾ Letzte gesendet (seit ${formatDateTime(since)})`,
    histLatestNone: (since) => `Keine gesendeten Angebote seit ${formatDateTime(since)}.`,
    histLatestNonePerLink: (linkId, since) => `Keine gesendeten Angebote fÃ¼r Link <b>${linkId}</b> seit ${formatDateTime(since)}.`,
    histLatestFooter: "VollstÃ¤ndiger Verlauf:",
    histCheapestTitle: "ğŸ’° GÃ¼nstigste gesendet",
    histCheapestPerLink: (linkId, linkName, since) => `ğŸ’° GÃ¼nstigste gesendet (Link ${linkId})\n<b>${escapeHtml(linkName || "(kein Name)")}</b>\nSeit: ${formatDateTime(since)}`,
    histCheapestGlobal: (since) => `ğŸ’° GÃ¼nstigste gesendet (seit ${formatDateTime(since)})`,
    histCheapestNone: (since) => `Keine gesendeten Angebote mit Preis seit ${formatDateTime(since)}.`,
    histCheapestNonePerLink: (linkId, since) => `Keine gesendeten Angebote mit Preis fÃ¼r Link <b>${linkId}</b> seit ${formatDateTime(since)}.`,
    histNoTitle: "(kein Titel)",
    histFullHistory: "VollstÃ¤ndiger Verlauf:",
    tz_current: (tz, now) => `ğŸŒ Aktuelle Zeitzone: <b>${tz}</b>\nJetzt: ${now}`,
    tz_usage: "Verwendung: <code>/timezone [zone|alias|reset]</code>\nBeispiele: <code>/timezone warsaw</code>, <code>/timezone Europe/London</code>, <code>/timezone reset</code>",
    tz_set_ok: (tz) => `âœ… Zeitzone eingestellt auf: <b>${tz}</b>`,
    tz_reset_ok: (tz) => `âœ… Zeitzone auf Standard zurÃ¼ckgesetzt: <b>${tz}</b>`,
    tz_invalid: (input) => `âŒ UngÃ¼ltige Zeitzone: <b>${input}</b>`,
    tz_examples: "GÃ¼ltige Beispiele:\nâ€¢ <code>/timezone warsaw</code>\nâ€¢ <code>/timezone Europe/Berlin</code>\nâ€¢ <code>/timezone newyork</code>\nâ€¢ <code>/timezone America/Los_Angeles</code>\nâ€¢ <code>/timezone reset</code>",
    settings_title: "âš™ï¸ Einstellungen",
    settings_open_panel: (url) => `Du kannst Sprache und Zeitzone im Panel verwalten: <a href="${url}">${url}</a>`,
    settings_hint: "Verwende <code>/timezone</code> um die Zeitzone in Telegram zu Ã¤ndern, oder besuche die Einstellungsseite.",
  },
  fr: {
    notifOn: "âœ… Notifications ACTIVÃ‰ES sur ce chat.",
    notifOff: "â›” Notifications DÃ‰SACTIVÃ‰ES sur ce chat.",
    modeSingle: "ğŸ“¨ Mode par dÃ©faut: <b>simple</b> (pour ce chat).",
    modeBatch: "ğŸ“¦ Mode par dÃ©faut: <b>batch</b> (pour ce chat).",
    linkEnabled: (id, prettyMode) => `âœ… Lien <b>${id}</b> ACTIVÃ‰ sur ce chat (hÃ©rite du mode chat: <b>${prettyMode}</b>).`,
    linkSet: (id, prettyMode) => `âœ… Lien <b>${id}</b> dÃ©fini sur: <b>${prettyMode}</b> sur ce chat`,
    linkNotYours: (id) => `âŒ Le lien <b>${id}</b> n'appartient pas Ã  votre compte.`,
    setModeFail: (reason) => `âŒ ${reason || "Impossible de dÃ©finir le mode."}`,
    quietSet: (from, to) => `ğŸŒ™ Heures silencieuses dÃ©finies: <b>${from}:00â€“${to}:00</b>`,
    quietOn: (from, to) => `ğŸŒ™ Heures silencieuses: <b>ACTIVÃ‰ES</b>, ${from}:00â€“${to}:00`,
    quietOff: "ğŸŒ™ Heures silencieuses: <b>DÃ‰SACTIVÃ‰ES</b>",
    histLatestTitle: "ğŸ§¾ DerniÃ¨res envoyÃ©es",
    histLatestPerLink: (linkId, linkName, since) => `ğŸ§¾ DerniÃ¨res envoyÃ©es (lien ${linkId})\n<b>${escapeHtml(linkName || "(sans nom)")}</b>\nDepuis: ${formatDateTime(since)}`,
    histLatestGlobal: (since) => `ğŸ§¾ DerniÃ¨res envoyÃ©es (depuis ${formatDateTime(since)})`,
    histLatestNone: (since) => `Aucune offre envoyÃ©e depuis ${formatDateTime(since)}.`,
    histLatestNonePerLink: (linkId, since) => `Aucune offre envoyÃ©e pour le lien <b>${linkId}</b> depuis ${formatDateTime(since)}.`,
    histLatestFooter: "Historique complet:",
    histCheapestTitle: "ğŸ’° Les moins chÃ¨res envoyÃ©es",
    histCheapestPerLink: (linkId, linkName, since) => `ğŸ’° Les moins chÃ¨res envoyÃ©es (lien ${linkId})\n<b>${escapeHtml(linkName || "(sans nom)")}</b>\nDepuis: ${formatDateTime(since)}`,
    histCheapestGlobal: (since) => `ğŸ’° Les moins chÃ¨res envoyÃ©es (depuis ${formatDateTime(since)})`,
    histCheapestNone: (since) => `Aucune offre avec prix envoyÃ©e depuis ${formatDateTime(since)}.`,
    histCheapestNonePerLink: (linkId, since) => `Aucune offre avec prix pour le lien <b>${linkId}</b> depuis ${formatDateTime(since)}.`,
    histNoTitle: "(sans titre)",
    histFullHistory: "Historique complet:",
    tz_current: (tz, now) => `ğŸŒ Fuseau horaire actuel : <b>${tz}</b>\nMaintenant : ${now}`,
    tz_usage: "Utilisation : <code>/timezone [zone|alias|reset]</code>\nExemples : <code>/timezone warsaw</code>, <code>/timezone Europe/London</code>, <code>/timezone reset</code>",
    tz_set_ok: (tz) => `âœ… Fuseau horaire dÃ©fini sur : <b>${tz}</b>`,
    tz_reset_ok: (tz) => `âœ… Fuseau horaire rÃ©initialisÃ© par dÃ©faut : <b>${tz}</b>`,
    tz_invalid: (input) => `âŒ Fuseau horaire invalide : <b>${input}</b>`,
    tz_examples: "Exemples valides :\nâ€¢ <code>/timezone warsaw</code>\nâ€¢ <code>/timezone Europe/Berlin</code>\nâ€¢ <code>/timezone newyork</code>\nâ€¢ <code>/timezone America/Los_Angeles</code>\nâ€¢ <code>/timezone reset</code>",
    settings_title: "âš™ï¸ ParamÃ¨tres",
    settings_open_panel: (url) => `Vous pouvez gÃ©rer votre langue et votre fuseau horaire dans le panneau : <a href="${url}">${url}</a>`,
    settings_hint: "Utilisez <code>/timezone</code> pour changer le fuseau horaire sur Telegram, ou visitez la page ParamÃ¨tres.",
  },
  es: {
    notifOn: "âœ… Notificaciones HABILITADAS en este chat.",
    notifOff: "â›” Notificaciones DESHABILITADAS en este chat.",
    modeSingle: "ğŸ“¨ Modo por defecto: <b>simple</b> (para este chat).",
    modeBatch: "ğŸ“¦ Modo por defecto: <b>lote</b> (para este chat).",
    linkEnabled: (id, prettyMode) => `âœ… Enlace <b>${id}</b> HABILITADO en este chat (hereda modo de chat: <b>${prettyMode}</b>).`,
    linkSet: (id, prettyMode) => `âœ… Enlace <b>${id}</b> establecido a: <b>${prettyMode}</b> en este chat`,
    linkNotYours: (id) => `âŒ El enlace <b>${id}</b> no pertenece a su cuenta.`,
    setModeFail: (reason) => `âŒ ${reason || "Error al establecer el modo."}`,
    quietSet: (from, to) => `ğŸŒ™ Horario silencioso establecido: <b>${from}:00â€“${to}:00</b>`,
    quietOn: (from, to) => `ğŸŒ™ Horario silencioso: <b>HABILITADO</b>, ${from}:00â€“${to}:00`,
    quietOff: "ğŸŒ™ Horario silencioso: <b>DESHABILITADO</b>",
    histLatestTitle: "ğŸ§¾ Ãšltimos enviados",
    histLatestPerLink: (linkId, linkName, since) => `ğŸ§¾ Ãšltimos enviados (enlace ${linkId})\n<b>${escapeHtml(linkName || "(sin nombre)")}</b>\nDesde: ${formatDateTime(since)}`,
    histLatestGlobal: (since) => `ğŸ§¾ Ãšltimos enviados (desde ${formatDateTime(since)})`,
    histLatestNone: (since) => `Sin ofertas enviadas desde ${formatDateTime(since)}.`,
    histLatestNonePerLink: (linkId, since) => `Sin ofertas enviadas para el enlace <b>${linkId}</b> desde ${formatDateTime(since)}.`,
    histLatestFooter: "Historial completo:",
    histCheapestTitle: "ğŸ’° MÃ¡s baratos enviados",
    histCheapestPerLink: (linkId, linkName, since) => `ğŸ’° MÃ¡s baratos enviados (enlace ${linkId})\n<b>${escapeHtml(linkName || "(sin nombre)")}</b>\nDesde: ${formatDateTime(since)}`,
    histCheapestGlobal: (since) => `ğŸ’° MÃ¡s baratos enviados (desde ${formatDateTime(since)})`,
    histCheapestNone: (since) => `Sin ofertas con precio enviadas desde ${formatDateTime(since)}.`,
    histCheapestNonePerLink: (linkId, since) => `Sin ofertas con precio para el enlace <b>${linkId}</b> desde ${formatDateTime(since)}.`,
    histNoTitle: "(sin tÃ­tulo)",
    histFullHistory: "Historial completo:",
    tz_current: (tz, now) => `ğŸŒ Fuseau horaire actuel : <b>${tz}</b>\nMaintenant : ${now}`,
    tz_usage: "Utilisation : <code>/timezone [zone|alias|reset]</code>\nExemples : <code>/timezone warsaw</code>, <code>/timezone Europe/London</code>, <code>/timezone reset</code>",
    tz_set_ok: (tz) => `âœ… Fuseau horaire dÃ©fini sur : <b>${tz}</b>`,
    tz_reset_ok: (tz) => `âœ… Fuseau horaire rÃ©initialisÃ© par dÃ©faut : <b>${tz}</b>`,
    tz_invalid: (input) => `âŒ Fuseau horaire invalide : <b>${input}</b>`,
    tz_examples: "Exemples valides :\nâ€¢ <code>/timezone warsaw</code>\nâ€¢ <code>/timezone Europe/Berlin</code>\nâ€¢ <code>/timezone newyork</code>\nâ€¢ <code>/timezone America/Los_Angeles</code>\nâ€¢ <code>/timezone reset</code>",
    settings_title: "âš™ï¸ ConfiguraciÃ³n",
    settings_open_panel: (url) => `Puedes gestionar tu idioma y zona horaria en el panel: <a href="${url}">${url}</a>`,
    settings_hint: "Usa <code>/timezone</code> para cambiar la zona horaria en Telegram, o visita la pÃ¡gina de ConfiguraciÃ³n.",
  },
  it: {
    notifOn: "âœ… Notifiche ABILITATE su questa chat.",
    notifOff: "â›” Notifiche DISABILITATE su questa chat.",
    modeSingle: "ğŸ“¨ ModalitÃ  predefinita: <b>singolo</b> (per questa chat).",
    modeBatch: "ğŸ“¦ ModalitÃ  predefinita: <b>batch</b> (per questa chat).",
    linkEnabled: (id, prettyMode) => `âœ… Collegamento <b>${id}</b> ABILITATO su questa chat (eredita modalitÃ  chat: <b>${prettyMode}</b>).`,
    linkSet: (id, prettyMode) => `âœ… Collegamento <b>${id}</b> impostato a: <b>${prettyMode}</b> su questa chat`,
    linkNotYours: (id) => `âŒ Il collegamento <b>${id}</b> non appartiene al tuo account.`,
    setModeFail: (reason) => `âŒ ${reason || "Impossibile impostare la modalitÃ ."}`,
    quietSet: (from, to) => `ğŸŒ™ Ore silenziose impostate: <b>${from}:00â€“${to}:00</b>`,
    quietOn: (from, to) => `ğŸŒ™ Ore silenziose: <b>ABILITATE</b>, ${from}:00â€“${to}:00`,
    quietOff: "ğŸŒ™ Ore silenziose: <b>DISABILITATE</b>",
    histLatestTitle: "ğŸ§¾ Ultimi inviati",
    histLatestPerLink: (linkId, linkName, since) => `ğŸ§¾ Ultimi inviati (collegamento ${linkId})\n<b>${escapeHtml(linkName || "(nessun nome)")}</b>\nDa: ${formatDateTime(since)}`,
    histLatestGlobal: (since) => `ğŸ§¾ Ultimi inviati (da ${formatDateTime(since)})`,
    histLatestNone: (since) => `Nessuna offerta inviata da ${formatDateTime(since)}.`,
    histLatestNonePerLink: (linkId, since) => `Nessuna offerta inviata per il collegamento <b>${linkId}</b> da ${formatDateTime(since)}.`,
    histLatestFooter: "Cronologia completa:",
    histCheapestTitle: "ğŸ’° PiÃ¹ economici inviati",
    histCheapestPerLink: (linkId, linkName, since) => `ğŸ’° PiÃ¹ economici inviati (collegamento ${linkId})\n<b>${escapeHtml(linkName || "(nessun nome)")}</b>\nDa: ${formatDateTime(since)}`,
    histCheapestGlobal: (since) => `ğŸ’° PiÃ¹ economici inviati (da ${formatDateTime(since)})`,
    histCheapestNone: (since) => `Nessuna offerta con prezzo inviata da ${formatDateTime(since)}.`,
    histCheapestNonePerLink: (linkId, since) => `Nessuna offerta con prezzo per il collegamento <b>${linkId}</b> da ${formatDateTime(since)}.`,
    histNoTitle: "(nessun titolo)",
    histFullHistory: "Cronologia completa:",
    tz_current: (tz, now) => `ğŸŒ Zona horaria actual: <b>${tz}</b>\nAhora: ${now}`,
    tz_usage: "Uso: <code>/timezone [zona|alias|reset]</code>\nEjemplos: <code>/timezone warsaw</code>, <code>/timezone Europe/London</code>, <code>/timezone reset</code>",
    tz_set_ok: (tz) => `âœ… Zona horaria establecida en: <b>${tz}</b>`,
    tz_reset_ok: (tz) => `âœ… Zona horaria restablecida a predeterminada: <b>${tz}</b>`,
    tz_invalid: (input) => `âŒ Zona horaria invÃ¡lida: <b>${input}</b>`,
    tz_examples: "Ejemplos vÃ¡lidos:\nâ€¢ <code>/timezone warsaw</code>\nâ€¢ <code>/timezone Europe/Berlin</code>\nâ€¢ <code>/timezone newyork</code>\nâ€¢ <code>/timezone America/Los_Angeles</code>\nâ€¢ <code>/timezone reset</code>",
    settings_title: "âš™ï¸ Impostazioni",
    settings_open_panel: (url) => `Puoi gestire la tua lingua e il fuso orario nel pannello: <a href="${url}">${url}</a>`,
    settings_hint: "Usa <code>/timezone</code> per cambiare il fuso orario su Telegram, o visita la pagina Impostazioni.",
  },
  pt: {
    notifOn: "âœ… NotificaÃ§Ãµes HABILITADAS neste chat.",
    notifOff: "â›” NotificaÃ§Ãµes DESABILITADAS neste chat.",
    modeSingle: "ğŸ“¨ Modo padrÃ£o: <b>simples</b> (para este chat).",
    modeBatch: "ğŸ“¦ Modo padrÃ£o: <b>lote</b> (para este chat).",
    linkEnabled: (id, prettyMode) => `âœ… Link <b>${id}</b> HABILITADO neste chat (herda modo de chat: <b>${prettyMode}</b>).`,
    linkSet: (id, prettyMode) => `âœ… Link <b>${id}</b> definido para: <b>${prettyMode}</b> neste chat`,
    linkNotYours: (id) => `âŒ O link <b>${id}</b> nÃ£o pertence Ã  sua conta.`,
    setModeFail: (reason) => `âŒ ${reason || "Falha ao definir o modo."}`,
    quietSet: (from, to) => `ğŸŒ™ HorÃ¡rio silencioso definido: <b>${from}:00â€“${to}:00</b>`,
    quietOn: (from, to) => `ğŸŒ™ HorÃ¡rio silencioso: <b>HABILITADO</b>, ${from}:00â€“${to}:00`,
    quietOff: "ğŸŒ™ HorÃ¡rio silencioso: <b>DESABILITADO</b>",
    histLatestTitle: "ğŸ§¾ Ãšltimos enviados",
    histLatestPerLink: (linkId, linkName, since) => `ğŸ§¾ Ãšltimos enviados (link ${linkId})\n<b>${escapeHtml(linkName || "(sem nome)")}</b>\nDesde: ${formatDateTime(since)}`,
    histLatestGlobal: (since) => `ğŸ§¾ Ãšltimos enviados (desde ${formatDateTime(since)})`,
    histLatestNone: (since) => `Nenhuma oferta enviada desde ${formatDateTime(since)}.`,
    histLatestNonePerLink: (linkId, since) => `Nenhuma oferta enviada para o link <b>${linkId}</b> desde ${formatDateTime(since)}.`,
    histLatestFooter: "HistÃ³rico completo:",
    histCheapestTitle: "ğŸ’° Mais baratos enviados",
    histCheapestPerLink: (linkId, linkName, since) => `ğŸ’° Mais baratos enviados (link ${linkId})\n<b>${escapeHtml(linkName || "(sem nome)")}</b>\nDesde: ${formatDateTime(since)}`,
    histCheapestGlobal: (since) => `ğŸ’° Mais baratos enviados (desde ${formatDateTime(since)})`,
    histCheapestNone: (since) => `Nenhuma oferta com preÃ§o enviada desde ${formatDateTime(since)}.`,
    histCheapestNonePerLink: (linkId, since) => `Nenhuma oferta com preÃ§o para o link <b>${linkId}</b> desde ${formatDateTime(since)}.`,
    histNoTitle: "(sem tÃ­tulo)",
    histFullHistory: "HistÃ³rico completo:",
    tz_current: (tz, now) => `ğŸŒ Fuso horÃ¡rio atual: <b>${tz}</b>\nAgora: ${now}`,
    tz_usage: "Uso: <code>/timezone [zona|alias|reset]</code>\nExemplos: <code>/timezone warsaw</code>, <code>/timezone Europe/London</code>, <code>/timezone reset</code>",
    tz_set_ok: (tz) => `âœ… Fuso horÃ¡rio definido para: <b>${tz}</b>`,
    tz_reset_ok: (tz) => `âœ… Fuso horÃ¡rio redefinido para padrÃ£o: <b>${tz}</b>`,
    tz_invalid: (input) => `âŒ Fuso horÃ¡rio invÃ¡lido: <b>${input}</b>`,
    tz_examples: "Exemplos vÃ¡lidos:\nâ€¢ <code>/timezone warsaw</code>\nâ€¢ <code>/timezone Europe/Berlin</code>\nâ€¢ <code>/timezone newyork</code>\nâ€¢ <code>/timezone America/Los_Angeles</code>\nâ€¢ <code>/timezone reset</code>",
    settings_title: "âš™ï¸ ConfiguraÃ§Ãµes",
    settings_open_panel: (url) => `VocÃª pode gerenciar seu idioma e fuso horÃ¡rio no painel: <a href="${url}">${url}</a>`,
    settings_hint: "Use <code>/timezone</code> para alterar o fuso horÃ¡rio no Telegram, ou visite a pÃ¡gina de ConfiguraÃ§Ãµes.",
  },
  ro: {
    notifOn: "âœ… NotificÄƒri ACTIVATE pe acest chat.",
    notifOff: "â›” NotificÄƒri DEZACTIVATE pe acest chat.",
    modeSingle: "ğŸ“¨ Mod implicit: <b>singular</b> (pentru acest chat).",
    modeBatch: "ğŸ“¦ Mod implicit: <b>lot</b> (pentru acest chat).",
    linkEnabled: (id, prettyMode) => `âœ… LegÄƒturÄƒ <b>${id}</b> ACTIVATÄ‚ pe acest chat (moÈ™teneÈ™te modul chat: <b>${prettyMode}</b>).`,
    linkSet: (id, prettyMode) => `âœ… LegÄƒturÄƒ <b>${id}</b> setatÄƒ la: <b>${prettyMode}</b> pe acest chat`,
    linkNotYours: (id) => `âŒ LegÄƒtura <b>${id}</b> nu aparÈ›ine contului tÄƒu.`,
    setModeFail: (reason) => `âŒ ${reason || "Eroare la setarea modului."}`,
    quietSet: (from, to) => `ğŸŒ™ Ore silenÈ›ioase setate: <b>${from}:00â€“${to}:00</b>`,
    quietOn: (from, to) => `ğŸŒ™ Ore silenÈ›ioase: <b>ACTIVATE</b>, ${from}:00â€“${to}:00`,
    quietOff: "ğŸŒ™ Ore silenÈ›ioase: <b>DEZACTIVATE</b>",
    histLatestTitle: "ğŸ§¾ Ultimele trimise",
    histLatestPerLink: (linkId, linkName, since) => `ğŸ§¾ Ultimele trimise (legÄƒturÄƒ ${linkId})\n<b>${escapeHtml(linkName || "(fÄƒrÄƒ nume)")}</b>\nDe la: ${formatDateTime(since)}`,
    histLatestGlobal: (since) => `ğŸ§¾ Ultimele trimise (de la ${formatDateTime(since)})`,
    histLatestNone: (since) => `Nicio ofertÄƒ trimisÄƒ de la ${formatDateTime(since)}.`,
    histLatestNonePerLink: (linkId, since) => `Nicio ofertÄƒ trimisÄƒ pentru legÄƒtura <b>${linkId}</b> de la ${formatDateTime(since)}.`,
    histLatestFooter: "Istoric complet:",
    histCheapestTitle: "ğŸ’° Cele mai ieftine trimise",
    histCheapestPerLink: (linkId, linkName, since) => `ğŸ’° Cele mai ieftine trimise (legÄƒturÄƒ ${linkId})\n<b>${escapeHtml(linkName || "(fÄƒrÄƒ nume)")}</b>\nDe la: ${formatDateTime(since)}`,
    histCheapestGlobal: (since) => `ğŸ’° Cele mai ieftine trimise (de la ${formatDateTime(since)})`,
    histCheapestNone: (since) => `Nicio ofertÄƒ cu preÈ› trimisÄƒ de la ${formatDateTime(since)}.`,
    histCheapestNonePerLink: (linkId, since) => `Nicio ofertÄƒ cu preÈ› pentru legÄƒtura <b>${linkId}</b> de la ${formatDateTime(since)}.`,
    histNoTitle: "(fÄƒrÄƒ titlu)",
    histFullHistory: "Istoric complet:",
    tz_current: (tz, now) => `ğŸŒ Fuso orario attuale: <b>${tz}</b>\nOra: ${now}`,
    tz_usage: "Uso: <code>/timezone [zona|alias|reset]</code>\nEsempi: <code>/timezone warsaw</code>, <code>/timezone Europe/London</code>, <code>/timezone reset</code>",
    tz_set_ok: (tz) => `âœ… Fuso orario impostato su: <b>${tz}</b>`,
    tz_reset_ok: (tz) => `âœ… Fuso orario ripristinato a predefinito: <b>${tz}</b>`,
    tz_invalid: (input) => `âŒ Fuso orario non valido: <b>${input}</b>`,
    tz_examples: "Esempi validi:\nâ€¢ <code>/timezone warsaw</code>\nâ€¢ <code>/timezone Europe/Berlin</code>\nâ€¢ <code>/timezone newyork</code>\nâ€¢ <code>/timezone America/Los_Angeles</code>\nâ€¢ <code>/timezone reset</code>",
    settings_title: "âš™ï¸ SetÄƒri",
    settings_open_panel: (url) => `PoÈ›i gestiona limba È™i fusul orar Ã®n panelul: <a href="${url}">${url}</a>`,
    settings_hint: "FoloseÈ™te <code>/timezone</code> pentru a schimba fusul orar Ã®n Telegram, sau viziteazÄƒ pagina de SetÄƒri.",
  },
  nl: {
    notifOn: "âœ… Meldingen INGESCHAKELD op deze chat.",
    notifOff: "â›” Meldingen UITGESCHAKELD op deze chat.",
    modeSingle: "ğŸ“¨ Standaardmodus: <b>enkel</b> (voor deze chat).",
    modeBatch: "ğŸ“¦ Standaardmodus: <b>batch</b> (voor deze chat).",
    linkEnabled: (id, prettyMode) => `âœ… Link <b>${id}</b> INGESCHAKELD op deze chat (erft chatmodus: <b>${prettyMode}</b>).`,
    linkSet: (id, prettyMode) => `âœ… Link <b>${id}</b> ingesteld op: <b>${prettyMode}</b> op deze chat`,
    linkNotYours: (id) => `âŒ Link <b>${id}</b> behoort niet tot uw account.`,
    setModeFail: (reason) => `âŒ ${reason || "Fout bij het instellen van de modus."}`,
    quietSet: (from, to) => `ğŸŒ™ Stille uren ingesteld: <b>${from}:00â€“${to}:00</b>`,
    quietOn: (from, to) => `ğŸŒ™ Stille uren: <b>INGESCHAKELD</b>, ${from}:00â€“${to}:00`,
    quietOff: "ğŸŒ™ Stille uren: <b>UITGESCHAKELD</b>",
    histLatestTitle: "ğŸ§¾ Laatst verzonden",
    histLatestPerLink: (linkId, linkName, since) => `ğŸ§¾ Laatst verzonden (link ${linkId})\n<b>${escapeHtml(linkName || "(geen naam)")}</b>\nSinds: ${formatDateTime(since)}`,
    histLatestGlobal: (since) => `ğŸ§¾ Laatst verzonden (sinds ${formatDateTime(since)})`,
    histLatestNone: (since) => `Geen verzonden aanbiedingen sinds ${formatDateTime(since)}.`,
    histLatestNonePerLink: (linkId, since) => `Geen verzonden aanbiedingen voor link <b>${linkId}</b> sinds ${formatDateTime(since)}.`,
    histLatestFooter: "Volledige geschiedenis:",
    histCheapestTitle: "ğŸ’° Goedkoopste verzonden",
    histCheapestPerLink: (linkId, linkName, since) => `ğŸ’° Goedkoopste verzonden (link ${linkId})\n<b>${escapeHtml(linkName || "(geen naam)")}</b>\nSinds: ${formatDateTime(since)}`,
    histCheapestGlobal: (since) => `ğŸ’° Goedkoopste verzonden (sinds ${formatDateTime(since)})`,
    histCheapestNone: (since) => `Geen verzonden aanbiedingen met prijs sinds ${formatDateTime(since)}.`,
    histCheapestNonePerLink: (linkId, since) => `Geen verzonden aanbiedingen met prijs voor link <b>${linkId}</b> sinds ${formatDateTime(since)}.`,
    histNoTitle: "(geen titel)",
    histFullHistory: "Volledige geschiedenis:",
    tz_current: (tz, now) => `ğŸŒ Fuso horÃ¡rio atual: <b>${tz}</b>\nAgora: ${now}`,
    tz_usage: "Uso: <code>/timezone [zona|alias|reset]</code>\nExemplos: <code>/timezone warsaw</code>, <code>/timezone Europe/London</code>, <code>/timezone reset</code>",
    tz_set_ok: (tz) => `âœ… Fuso horÃ¡rio definido para: <b>${tz}</b>`,
    tz_reset_ok: (tz) => `âœ… Fuso horÃ¡rio redefinido para padrÃ£o: <b>${tz}</b>`,
    tz_invalid: (input) => `âŒ Fuso horÃ¡rio invÃ¡lido: <b>${input}</b>`,
    tz_examples: "Exemplos vÃ¡lidos:\nâ€¢ <code>/timezone warsaw</code>\nâ€¢ <code>/timezone Europe/Berlin</code>\nâ€¢ <code>/timezone newyork</code>\nâ€¢ <code>/timezone America/Los_Angeles</code>\nâ€¢ <code>/timezone reset</code>",
    settings_title: "âš™ï¸ Instellingen",
    settings_open_panel: (url) => `Je kunt je taal en tijdzone beheren in het paneel: <a href="${url}">${url}</a>`,
    settings_hint: "Gebruik <code>/timezone</code> om de tijdzone in Telegram te wijzigen, of bezoek de Instellingenpagina.",
  },
  cs: {
    notifOn: "âœ… OznÃ¡menÃ­ POVOLENA v tomto chatu.",
    notifOff: "â›” OznÃ¡menÃ­ ZAKÃZÃNA v tomto chatu.",
    modeSingle: "ğŸ“¨ VÃ½chozÃ­ reÅ¾im: <b>jednotlivÃ©</b> (pro tento chat).",
    modeBatch: "ğŸ“¦ VÃ½chozÃ­ reÅ¾im: <b>dÃ¡vka</b> (pro tento chat).",
    linkEnabled: (id, prettyMode) => `âœ… Odkaz <b>${id}</b> POVOLEN v tomto chatu (dÄ›dÃ­ reÅ¾im chatu: <b>${prettyMode}</b>).`,
    linkSet: (id, prettyMode) => `âœ… Odkaz <b>${id}</b> nastaven na: <b>${prettyMode}</b> v tomto chatu`,
    linkNotYours: (id) => `âŒ Odkaz <b>${id}</b> nepatÅ™Ã­ vaÅ¡emu ÃºÄtu.`,
    setModeFail: (reason) => `âŒ ${reason || "Chyba pÅ™i nastavenÃ­ reÅ¾imu."}`,
    quietSet: (from, to) => `ğŸŒ™ TichÃ¡ doba nastavena: <b>${from}:00â€“${to}:00</b>`,
    quietOn: (from, to) => `ğŸŒ™ TichÃ¡ doba: <b>POVOLENA</b>, ${from}:00â€“${to}:00`,
    quietOff: "ğŸŒ™ TichÃ¡ doba: <b>ZAKÃZÃNA</b>",
    histLatestTitle: "ğŸ§¾ PoslednÃ­ odeslanÃ©",
    histLatestPerLink: (linkId, linkName, since) => `ğŸ§¾ PoslednÃ­ odeslanÃ© (odkaz ${linkId})\n<b>${escapeHtml(linkName || "(bez nÃ¡zvu)")}</b>\nOd: ${formatDateTime(since)}`,
    histLatestGlobal: (since) => `ğŸ§¾ PoslednÃ­ odeslanÃ© (od ${formatDateTime(since)})`,
    histLatestNone: (since) => `Å½Ã¡dnÃ© odeslanÃ© nabÃ­dky od ${formatDateTime(since)}.`,
    histLatestNonePerLink: (linkId, since) => `Å½Ã¡dnÃ© odeslanÃ© nabÃ­dky pro odkaz <b>${linkId}</b> od ${formatDateTime(since)}.`,
    histLatestFooter: "ÃšplnÃ¡ historie:",
    histCheapestTitle: "ğŸ’° NejlevnÄ›jÅ¡Ã­ odeslanÃ©",
    histCheapestPerLink: (linkId, linkName, since) => `ğŸ’° NejlevnÄ›jÅ¡Ã­ odeslanÃ© (odkaz ${linkId})\n<b>${escapeHtml(linkName || "(bez nÃ¡zvu)")}</b>\nOd: ${formatDateTime(since)}`,
    histCheapestGlobal: (since) => `ğŸ’° NejlevnÄ›jÅ¡Ã­ odeslanÃ© (od ${formatDateTime(since)})`,
    histCheapestNone: (since) => `Å½Ã¡dnÃ© odeslanÃ© nabÃ­dky s cenou od ${formatDateTime(since)}.`,
    histCheapestNonePerLink: (linkId, since) => `Å½Ã¡dnÃ© odeslanÃ© nabÃ­dky s cenou pro odkaz <b>${linkId}</b> od ${formatDateTime(since)}.`,
    histNoTitle: "(bez nÃ¡zvu)",
    histFullHistory: "ÃšplnÃ¡ historie:",
    tz_current: (tz, now) => `ğŸŒ Fusul orar curent: <b>${tz}</b>\nAcum: ${now}`,
    tz_usage: "Utilizare: <code>/timezone [zona|alias|reset]</code>\nExemple: <code>/timezone warsaw</code>, <code>/timezone Europe/London</code>, <code>/timezone reset</code>",
    tz_set_ok: (tz) => `âœ… Fusul orar setat la: <b>${tz}</b>`,
    tz_reset_ok: (tz) => `âœ… Fusul orar resetat la implicit: <b>${tz}</b>`,
    tz_invalid: (input) => `âŒ Fus orar invalid: <b>${input}</b>`,
    tz_examples: "Exemple valide:\nâ€¢ <code>/timezone warsaw</code>\nâ€¢ <code>/timezone Europe/Berlin</code>\nâ€¢ <code>/timezone newyork</code>\nâ€¢ <code>/timezone America/Los_Angeles</code>\nâ€¢ <code>/timezone reset</code>",
    settings_title: "âš™ï¸ NastavenÃ­",
    settings_open_panel: (url) => `SvÅ¯j jazyk a ÄasovÃ© pÃ¡smo mÅ¯Å¾eÅ¡ spravovat v panelu: <a href="${url}">${url}</a>`,
    settings_hint: "PouÅ¾ij <code>/timezone</code> pro zmÄ›nu ÄasovÃ©ho pÃ¡sma v Telegramu, nebo navÅ¡tiv strÃ¡nku NastavenÃ­.",
  },
  sk: {
    notifOn: "âœ… OznÃ¡menia POVOLENÃ‰ v tomto chate.",
    notifOff: "â›” OznÃ¡menia ZAKÃZANÃ‰ v tomto chate.",
    modeSingle: "ğŸ“¨ PredvolenÃ½ reÅ¾im: <b>jednotlivÃ©</b> (pre tento chat).",
    modeBatch: "ğŸ“¦ PredvolenÃ½ reÅ¾im: <b>dÃ¡vka</b> (pre tento chat).",
    linkEnabled: (id, prettyMode) => `âœ… Odkaz <b>${id}</b> POVOLENÃ v tomto chate (dedÃ­ reÅ¾im chatu: <b>${prettyMode}</b>).`,
    linkSet: (id, prettyMode) => `âœ… Odkaz <b>${id}</b> nastavenÃ½ na: <b>${prettyMode}</b> v tomto chate`,
    linkNotYours: (id) => `âŒ Odkaz <b>${id}</b> nepatrÃ­ vÃ¡Å¡mu konto.`,
    setModeFail: (reason) => `âŒ ${reason || "Chyba pri nastavenÃ­ reÅ¾imu."}`,
    quietSet: (from, to) => `ğŸŒ™ TichÃ½ Äas nastavenÃ½: <b>${from}:00â€“${to}:00</b>`,
    quietOn: (from, to) => `ğŸŒ™ TichÃ½ Äas: <b>POVOLENÃ</b>, ${from}:00â€“${to}:00`,
    quietOff: "ğŸŒ™ TichÃ½ Äas: <b>ZAKÃZANÃ</b>",
    histLatestTitle: "ğŸ§¾ PoslednÃ© odoslanÃ©",
    histLatestPerLink: (linkId, linkName, since) => `ğŸ§¾ PoslednÃ© odoslanÃ© (odkaz ${linkId})\n<b>${escapeHtml(linkName || "(bez nÃ¡zvu)")}</b>\nOd: ${formatDateTime(since)}`,
    histLatestGlobal: (since) => `ğŸ§¾ PoslednÃ© odoslanÃ© (od ${formatDateTime(since)})`,
    histLatestNone: (since) => `Å½iadne odoslanÃ© ponuky od ${formatDateTime(since)}.`,
    histLatestNonePerLink: (linkId, since) => `Å½iadne odoslanÃ© ponuky pre odkaz <b>${linkId}</b> od ${formatDateTime(since)}.`,
    histLatestFooter: "ÃšplnÃ¡ histÃ³ria:",
    histCheapestTitle: "ğŸ’° NajlacnejÅ¡ie odoslanÃ©",
    histCheapestPerLink: (linkId, linkName, since) => `ğŸ’° NajlacnejÅ¡ie odoslanÃ© (odkaz ${linkId})\n<b>${escapeHtml(linkName || "(bez nÃ¡zvu)")}</b>\nOd: ${formatDateTime(since)}`,
    histCheapestGlobal: (since) => `ğŸ’° NajlacnejÅ¡ie odoslanÃ© (od ${formatDateTime(since)})`,
    histCheapestNone: (since) => `Å½iadne odoslanÃ© ponuky s cenou od ${formatDateTime(since)}.`,
    histCheapestNonePerLink: (linkId, since) => `Å½iadne odoslanÃ© ponuky s cenou pre odkaz <b>${linkId}</b> od ${formatDateTime(since)}.`,
    histNoTitle: "(bez nÃ¡zvu)",
    histFullHistory: "ÃšplnÃ¡ histÃ³ria:",
    tz_current: (tz, now) => `ğŸŒ Huidige tijdzone: <b>${tz}</b>\nNu: ${now}`,
    tz_usage: "Gebruik: <code>/timezone [zone|alias|reset]</code>\nVoorbeelden: <code>/timezone warsaw</code>, <code>/timezone Europe/London</code>, <code>/timezone reset</code>",
    tz_set_ok: (tz) => `âœ… Tijdzone ingesteld op: <b>${tz}</b>`,
    tz_reset_ok: (tz) => `âœ… Tijdzone gereset naar standaard: <b>${tz}</b>`,
    tz_invalid: (input) => `âŒ Ongeldige tijdzone: <b>${input}</b>`,
    tz_examples: "Geldige voorbeelden:\nâ€¢ <code>/timezone warsaw</code>\nâ€¢ <code>/timezone Europe/Berlin</code>\nâ€¢ <code>/timezone newyork</code>\nâ€¢ <code>/timezone America/Los_Angeles</code>\nâ€¢ <code>/timezone reset</code>",
    settings_title: "âš™ï¸ Nastavenia",
    settings_open_panel: (url) => `Svoj jazyk a ÄasovÃ© pÃ¡smo mÃ´Å¾eÅ¡ spravovaÅ¥ v paneli: <a href="${url}">${url}</a>`,
    settings_hint: "PouÅ¾ij <code>/timezone</code> na zmenu ÄasovÃ©ho pÃ¡sma v Telegramu, alebo navÅ¡tÃ­v strÃ¡nku Nastavenia.",
  }
};

function getUserLang(user) {
  return normalizeLangCode(user?.language_code || user?.lang || user?.language || "en");
}

function modePretty(lang, mode) {
  const m = String(mode || "single").toLowerCase();
  if (lang === "pl") return m === "batch" ? "zbiorczo" : m === "off" ? "OFF" : "pojedynczo";
  return m === "batch" ? "batch" : m === "off" ? "OFF" : "single";
}

async function handleLanguage(msg, user) {
  const chatId = String(msg.chat.id);
  const arg = (msg.text || "").trim().split(/\s+/).slice(1).join(" ").trim().toLowerCase();

  const currentLang = user.lang || "en";
  const t = LANG_I18N[currentLang] || LANG_I18N.en;

  if (!arg) {
    const langName = SUPPORTED_LANGS[currentLang] || "English";
    
    // Build inline keyboard with 2 columns
    const langCodes = Object.keys(SUPPORTED_LANGS);
    const keyboard = [];
    for (let i = 0; i < langCodes.length; i += 2) {
      const row = [];
      row.push({
        text: SUPPORTED_LANGS[langCodes[i]],
        callback_data: `setlang:${langCodes[i]}`
      });
      if (i + 1 < langCodes.length) {
        row.push({
          text: SUPPORTED_LANGS[langCodes[i + 1]],
          callback_data: `setlang:${langCodes[i + 1]}`
        });
      }
      keyboard.push(row);
    }
    
    await tgSend(
      chatId,
      `${t.currentLanguage}<b>${langName}</b>\n\n${t.available}`,
      { reply_markup: { inline_keyboard: keyboard } }
    );
    return;
  }

  // Normalize: "pl-PL" -> "pl", "en-US" -> "en"
  const normalized = arg.split("-")[0].toLowerCase();
  
  if (!SUPPORTED_LANGS[normalized]) {
    // Use comma-separated codes for error message (short format)
    const langList = Object.keys(SUPPORTED_LANGS).join(", ");
    await tgSend(chatId, `${t.unknown}${langList}`);
    return;
  }

  // Update users.lang AND language_code (trigger will sync)
  process.stderr.write(`[lang_debug] Updating user ${user.id} lang from ${user.lang} to ${normalized}\n`);
  await dbQuery(
    `UPDATE users
     SET lang = $1,
         language = $1,
         language_code = $1,
         updated_at = NOW()
     WHERE id = $2`,
    [normalized, user.id]
  );
  process.stderr.write(`[lang_debug] Update completed for user ${user.id}\n`);

  const langName = SUPPORTED_LANGS[normalized];
  const confirmTemplate = getLangConfirmTemplate(normalized);
  await tgSend(chatId, confirmTemplate(langName));
}

// ---------- handleTimezone ----------

// Loose aliases for user-friendly timezone input
const TIMEZONE_ALIASES = {
  warsaw: "Europe/Warsaw",
  london: "Europe/London",
  berlin: "Europe/Berlin",
  paris: "Europe/Paris",
  amsterdam: "Europe/Amsterdam",
  prague: "Europe/Prague",
  vienna: "Europe/Vienna",
  madrid: "Europe/Madrid",
  rome: "Europe/Rome",
  newyork: "America/New_York",
  losangeles: "America/Los_Angeles",
};

function validateTimezone(tz) {
  try {
    // IANA validation via Intl.DateTimeFormat
    Intl.DateTimeFormat("en-US", { timeZone: tz });
    return true;
  } catch (e) {
    return false;
  }
}

function formatNowInTimezone(tz) {
  const now = new Date();
  return now.toLocaleString("en-US", {
    timeZone: tz,
    year: "numeric",
    month: "2-digit",
    day: "2-digit",
    hour: "2-digit",
    minute: "2-digit",
    second: "2-digit",
    hour12: false
  });
}

async function handleTimezone(msg, user) {
  const chatId = String(msg.chat.id);
  const arg = (msg.text || "").trim().split(/\s+/).slice(1).join(" ").trim().toLowerCase();

  const currentLang = getUserLang(user);
  const t = CMD_I18N[currentLang] || CMD_I18N.en;

  const currentTz = user.timezone || "Europe/Warsaw";

  // No argument: show current timezone + formatted time + usage
  if (!arg) {
    const now = formatNowInTimezone(currentTz);
    await tgSend(chatId, t.tz_current(currentTz, now) + "\n\n" + t.tz_usage);
    return;
  }

  // Reset: set to default Europe/Warsaw
  if (arg === "reset") {
    const defaultTz = "Europe/Warsaw";
    await dbQuery(
      `UPDATE users SET timezone = $1, updated_at = NOW() WHERE id = $2`,
      [defaultTz, user.id]
    );
    await tgSend(chatId, t.tz_reset_ok(defaultTz));
    return;
  }

  // Resolve alias (warsaw â†’ Europe/Warsaw, etc.)
  let resolvedTz = TIMEZONE_ALIASES[arg] || arg;

  // Validate IANA timezone
  if (!validateTimezone(resolvedTz)) {
    await tgSend(chatId, t.tz_invalid(arg) + "\n\n" + t.tz_examples);
    return;
  }

  // Save to users.timezone
  await dbQuery(
    `UPDATE users SET timezone = $1, updated_at = NOW() WHERE id = $2`,
    [resolvedTz, user.id]
  );

  await tgSend(chatId, t.tz_set_ok(resolvedTz));
}

// ---------- handleSettings ----------

async function handleSettings(msg, user) {
  const chatId = String(msg.chat.id);
  const currentLang = getUserLang(user);
  const t = CMD_I18N[currentLang] || CMD_I18N.en;
  const panelUrl = "https://panel.findyourdeal.app/settings";

  const message = `${t.settings_title}\n\n${t.settings_open_panel(panelUrl)}\n\n${t.settings_hint}`;
  await tgSend(chatId, message);
}

// ---------- cisza nocna ----------

async function handleQuiet(msg) {
  const chatId = String(msg.chat.id);
  const lang = getUserLang({ lang: (await getUserWithPlanByTelegramId(String(msg.from?.id || "")))?.lang, language_code: msg.from?.language_code });
  const t = CMD_I18N[lang] || CMD_I18N.en;
  const arg = (msg.text || "").trim().split(/\s+/).slice(1).join(" ").trim();

  if (!arg) {
    const qh = await getQuietHours(chatId);
    if (qh?.quiet_enabled) {
      await tgSend(chatId, t.quietOn(qh.quiet_from ?? 22, qh.quiet_to ?? 7));
    } else {
      await tgSend(chatId, `${t.quietOff}\nUstaw: <code>/cisza 22-7</code>`);
    }
    return;
  }

  const m = arg.match(/^(\d{1,2})\s*-\s*(\d{1,2})$/);
  if (!m) {
    await tgSend(chatId, "Podaj zakres jako HH-HH, np. <code>/cisza 22-7</code>");
    return;
  }

  const fromHour = Number(m[1]);
  const toHour = Number(m[2]);

  if (
    !Number.isFinite(fromHour) || !Number.isFinite(toHour) ||
    fromHour < 0 || fromHour > 23 || toHour < 0 || toHour > 23
  ) {
    await tgSend(chatId, "Godziny muszÄ… byÄ‡ w zakresie 0â€“23, np. <code>/cisza 22-7</code>");
    return;
  }

  await setQuietHours(chatId, fromHour, toHour);
  await tgSend(chatId, t.quietSet(fromHour, toHour));
}

async function handleQuietOff(msg) {
  const chatId = String(msg.chat.id);
  const lang = getUserLang({ lang: (await getUserWithPlanByTelegramId(String(msg.from?.id || "")))?.lang, language_code: msg.from?.language_code });
  await disableQuietHours(chatId);
  const t = CMD_I18N[lang] || CMD_I18N.en;
  await tgSend(chatId, t.quietOff);
}

// ---------- /najnowsze /najtansze (wysÅ‚ane do Telegrama) ----------

async function handleNajnowsze(msg, user, argText) {
  const chatId = String(msg.chat.id);
  const lang = getUserLang(user);
  const t = CMD_I18N[lang] || CMD_I18N.en;
  const linkId = Number(argText);
  const sinceChat = await fetchChatNotifyFrom(chatId, user.id);

  if (Number.isFinite(linkId) && linkId > 0) {
    const linkQ = await dbQuery(
      `SELECT id, name, url, notify_from FROM links WHERE id = $1 AND user_id = $2 LIMIT 1`,
      [linkId, user.id]
    );

    if (!linkQ.rowCount) {
      await tgSend(chatId, `Nie widzÄ™ linku <b>${linkId}</b> na Twoim koncie. SprawdÅº <code>/lista</code>.`);
      return;
    }

    const linkRow = linkQ.rows[0];
    const since = new Date(
      Math.max(new Date(linkRow.notify_from || 0).getTime(), sinceChat.getTime())
    );

    const itemsQ = await dbQuery(
      `
      SELECT title, price, currency, url, sent_at
      FROM sent_offers
      WHERE user_id = $1 AND chat_id = $2 AND link_id = $3 AND sent_at >= $4
      ORDER BY sent_at DESC
      LIMIT 10
      `,
      [user.id, chatId, linkId, since]
    );

    if (!itemsQ.rowCount) {
      await tgSend(chatId, t.histLatestNonePerLink(linkId, since));
      return;
    }

    let out = t.histLatestPerLink(linkId, linkRow.name || "", since) + "\n\n";

    itemsQ.rows.forEach((it, idx) => {
      const title = escapeHtml(it.title || t.histNoTitle);
      const priceStr =
        it.price != null ? `${it.price} ${it.currency || ""}`.trim() : "";

      out += `${idx + 1}. <b>${title}</b>\n`;
      if (priceStr) out += `ğŸ’° ${escapeHtml(priceStr)}\n`;
      if (it.url) out += `${escapeHtml(it.url)}\n`;
      out += `ğŸ“… ${formatDateTime(it.sent_at)}\n\n`;
    });

    await tgSend(chatId, out.trim(), { disable_web_page_preview: true });
    return;
  }

  const globalQ = await dbQuery(
    `
    SELECT so.link_id, so.title, so.price, so.currency, so.url, so.sent_at, l.name AS link_name
    FROM sent_offers so
    JOIN links l ON l.id = so.link_id
    WHERE so.user_id = $1 AND so.chat_id = $2 AND so.sent_at >= $3
    ORDER BY so.sent_at DESC
    LIMIT 10
    `,
    [user.id, chatId, sinceChat]
  );

  if (!globalQ.rowCount) {
    await tgSend(chatId, t.histLatestNone(sinceChat));
    return;
  }

  let out = t.histLatestGlobal(sinceChat) + "\n\n";
  const linkHints = new Set();

  globalQ.rows.forEach((row, idx) => {
    const priceStr =
      row.price != null ? `${row.price} ${row.currency || ""}`.trim() : "";
    out += `${idx + 1}. [${row.link_id}] ${escapeHtml(row.link_name || "(no name)")}\n`;
    out += `<b>${escapeHtml(row.title || t.histNoTitle)}</b>\n`;
    if (priceStr) out += `ğŸ’° ${escapeHtml(priceStr)}\n`;
    if (row.url) out += `${escapeHtml(row.url)}\n`;
    out += `ğŸ“… ${formatDateTime(row.sent_at)}\n\n`;
    linkHints.add(row.link_id);
  });

  if (linkHints.size) {
    out += `${t.histLatestFooter} ${[...linkHints]
      .map((id) => `/najnowsze ${id}`)
      .join(" ")}`;
  }

  await tgSend(chatId, out.trim(), { disable_web_page_preview: true });
}

async function handleNajtansze(msg, user, argText) {
  const chatId = String(msg.chat.id);
  const lang = getUserLang(user);
  const t = CMD_I18N[lang] || CMD_I18N.en;
  const linkId = Number(argText);
  const sinceChat = await fetchChatNotifyFrom(chatId, user.id);

  if (Number.isFinite(linkId) && linkId > 0) {
    const linkQ = await dbQuery(
      `SELECT id, name, url, notify_from FROM links WHERE id = $1 AND user_id = $2 LIMIT 1`,
      [linkId, user.id]
    );

    if (!linkQ.rowCount) {
      await tgSend(chatId, `Nie widzÄ™ linku <b>${linkId}</b> na Twoim koncie. SprawdÅº <code>/lista</code>.`);
      return;
    }

    const linkRow = linkQ.rows[0];
    const since = new Date(
      Math.max(new Date(linkRow.notify_from || 0).getTime(), sinceChat.getTime())
    );

    const itemsQ = await dbQuery(
      `
      SELECT title, price, currency, url, sent_at
      FROM sent_offers
      WHERE user_id = $1 AND chat_id = $2 AND link_id = $3 AND sent_at >= $4 AND price IS NOT NULL
      ORDER BY price ASC NULLS LAST, sent_at DESC
      LIMIT 10
      `,
      [user.id, chatId, linkId, since]
    );

    if (!itemsQ.rowCount) {
      await tgSend(chatId, t.histCheapestNonePerLink(linkId, since));
      return;
    }

    let out = t.histCheapestPerLink(linkId, linkRow.name || "", since) + "\n\n";

    itemsQ.rows.forEach((it, idx) => {
      const priceStr =
        it.price != null ? `${it.price} ${it.currency || ""}`.trim() : "";

      out += `${idx + 1}. <b>${escapeHtml(it.title || t.histNoTitle)}</b>\n`;
      if (priceStr) out += `ğŸ’° ${escapeHtml(priceStr)}\n`;
      if (it.url) out += `${escapeHtml(it.url)}\n`;
      out += `ğŸ“… ${formatDateTime(it.sent_at)}\n\n`;
    });

    await tgSend(chatId, out.trim(), { disable_web_page_preview: true });
    return;
  }

  const globalQ = await dbQuery(
    `
    SELECT so.link_id, so.title, so.price, so.currency, so.url, so.sent_at, l.name AS link_name
    FROM sent_offers so
    JOIN links l ON l.id = so.link_id
    WHERE so.user_id = $1 AND so.chat_id = $2 AND so.sent_at >= $3 AND so.price IS NOT NULL
    ORDER BY so.price ASC NULLS LAST, so.sent_at DESC
    LIMIT 10
    `,
    [user.id, chatId, sinceChat]
  );

  if (!globalQ.rowCount) {
    await tgSend(chatId, t.histCheapestNone(sinceChat));
    return;
  }

  let out = t.histCheapestGlobal(sinceChat) + "\n\n";
  const linkHints = new Set();

  globalQ.rows.forEach((row, idx) => {
    const priceStr =
      row.price != null ? `${row.price} ${row.currency || ""}`.trim() : "";
    out += `${idx + 1}. [${row.link_id}] ${escapeHtml(row.link_name || "(no name)")}\n`;
    out += `<b>${escapeHtml(row.title || t.histNoTitle)}</b>\n`;
    if (priceStr) out += `ğŸ’° ${escapeHtml(priceStr)}\n`;
    if (row.url) out += `${escapeHtml(row.url)}\n`;
    out += `ğŸ“… ${formatDateTime(row.sent_at)}\n\n`;
    linkHints.add(row.link_id);
  });

  if (linkHints.size) {
    out += `${t.histFullHistory} ${[...linkHints]
      .map((id) => `/najtansze ${id}`)
      .join(" ")}`;
  }

  await tgSend(chatId, out.trim(), { disable_web_page_preview: true });
}

// ---------- /admin_reset (tylko ADMIN_TG_ID) ----------

async function handleAdminReset(msg, user, argText) {
  const chatId = String(msg.chat.id);
  const fromId = String(msg.from?.id || "");

  if (!ADMIN_TG_ID || fromId !== ADMIN_TG_ID) {
    await tgSend(chatId, "Brak uprawnieÅ„ do tej komendy.");
    return;
  }

  const targetTgId = (argText || "").trim();
  if (!targetTgId) {
    await tgSend(chatId, "UÅ¼ycie: <code>/admin_reset &lt;tg_id&gt;</code>");
    return;
  }

  const targetUserId = await getUserIdByTelegramId(targetTgId);
  if (!targetUserId) {
    await tgSend(chatId, `Nie znalazÅ‚em uÅ¼ytkownika o TG ID ${escapeHtml(targetTgId)}.`);
    return;
  }

  const chatUpd = await dbQuery(
    `
    UPDATE chat_notifications
    SET notify_from = NOW(), daily_count = 0, daily_count_date = CURRENT_DATE
    WHERE user_id = $1
    `,
    [targetUserId]
  );

  const linkUpd = await dbQuery(
    `
    UPDATE links
    SET notify_from = NOW()
    WHERE user_id = $1
    `,
    [targetUserId]
  );

  await tgSend(
    chatId,
    `Reset wykonany dla tg_id=${escapeHtml(targetTgId)} (user_id=${targetUserId}).\nchat_rows=${chatUpd.rowCount} link_rows=${linkUpd.rowCount}`
  );
}

// ---------- callback_query z przyciskÃ³w (lnmode:ID:mode) ----------

async function handleCallback(update) {
  const cq = update.callback_query;
  if (!cq) return;

  const data = cq.data || "";
  const chatId = cq.message?.chat?.id;
  const fromId = cq.from?.id ? String(cq.from.id) : null;

  if (!chatId || !fromId) {
    await tgAnswerCb(cq.id, "Brak danych czatu/uÅ¼ytkownika.");
    return;
  }

  const userId = await resolveUserIdFromTg(fromId);
  if (!userId) {
    await tgAnswerCb(cq.id, "Nie widzÄ™ CiÄ™ w bazie. UÅ¼yj /start lub /dodaj.");
    return;
  }

  await ensureChatNotificationsRow(String(chatId), userId);

  // lnmode:<linkId>:<off|single|batch>
  const m = data.match(/^lnmode:(\d+):(off|single|batch)$/i);
  if (m) {
    const linkId = Number(m[1]);
    const mode = String(m[2]).toLowerCase();

    const res = await setPerLinkMode(String(chatId), userId, linkId, mode);
    if (!res.ok) {
      // Localized error (fallback EN)
      await tgAnswerCb(cq.id, res.reason || "Failed to set mode.", true);
      return;
    }

    // Localized confirmation (fallback EN)
    const user = await getUserById(userId);
    const lang = getUserLang(user);
    const pretty = modePretty(lang, res.mode);
    await tgAnswerCb(cq.id, `âœ“ ${pretty}`);
    return;
  }

  // setlang:<langCode>
  const langMatch = data.match(/^setlang:([a-z]{2})$/i);
  if (langMatch) {
    const langCode = langMatch[1].toLowerCase();
    
    if (!SUPPORTED_LANGS[langCode]) {
      await tgAnswerCb(cq.id, "Nieznany jÄ™zyk.", true);
      return;
    }
    
    // Update user's language
    await dbQuery(
      `UPDATE users
       SET lang = $1,
           language = $1,
           language_code = $1,
           updated_at = NOW()
       WHERE id = $2`,
      [langCode, userId]
    );
    
    process.stderr.write(`[lang_debug] Updating user ${userId} lang from ${cq.from.language_code || 'unknown'} to ${langCode} (via callback)\n`);
    
    const langName = SUPPORTED_LANGS[langCode];
    const confirmTemplate = getLangConfirmTemplate(langCode);
    
    // Answer callback and edit message
    await tgAnswerCb(cq.id, `âœ“ ${langName}`);
    
    // Send new message with confirmation
    await tgSend(String(chatId), confirmTemplate(langName));
    return;
  }

  await tgAnswerCb(cq.id, "Unknown action.");
}

// ---------- obsÅ‚uga pojedynczego update ----------

async function handleUpdate(update) {
  if (update.callback_query) {
    await handleCallback(update);
    return;
  }

  const msg = update.message;
  if (!msg || !msg.text) return;

  const chatId = msg.chat.id;
  const from = msg.from || {};
  const tgId = from.id ? String(from.id) : null;
let text = (msg.text ?? "").trim();

// NORMALIZACJA: pozwÃ³l na spacjÄ™ zamiast "_"
const m = text.match(/^\/(on|off|pojedyncze|pojedynczo|zbiorcze)\s+(\d+)\b/i);
if (m) {
  const cmd = m[1].toLowerCase() === "pojedynczo" ? "pojedyncze" : m[1].toLowerCase();
  text = `/${cmd}_${m[2]}`;
}

  console.log("TG message:", chatId, text);

  if (!tgId) {
    await tgSend(chatId, "Nie udaÅ‚o siÄ™ ustaliÄ‡ Twojego ID Telegram. SprÃ³buj ponownie.");
    return;
  }

  // rejestracja / aktualizacja profilu
  await initDb();
// W grupach moÅ¼e nie byÄ‡ from (anonimowy admin / sender_chat)
if (!from || !from.id) {
  console.warn("TG update bez from.id (anon admin / sender_chat) â€“ pomijam komendÄ™");
  return;
}


await ensureUser(
  from.id,
  from.username || null,
  from.first_name || null,
  from.last_name || null,
  from.language_code || null
);

  // alias / user
  const resolvedId = await resolveUserIdFromTg(tgId);

  let user = null;
  if (resolvedId === 1) {
    user = await getUserById(1);
  } else {
    user = await getUserWithPlanByTelegramId(tgId);
  }

  if (!user) {
    await tgSend(
      chatId,
      "Nie widzÄ™ CiÄ™ jeszcze w bazie.\nNajpierw uÅ¼yj /dodaj (zarejestruje konto), a potem /status."
    );
    return;
  }

  await ensureChatNotificationsRow(String(chatId), user.id);

  // parsowanie komend
  const [commandRaw, ...rest] = text.split(/\s+/);
  const command = commandRaw.toLowerCase().split("\@")[0];
  const argText = rest.join(" ").trim();

// komendy per-link: /pojedyncze_18 /zbiorcze_18 /off_18 /on_18
const perLink = command.match(/^\/(pojedyncze|zbiorcze|off|on)_(\d+)$/i);
if (perLink) {
  const kind = perLink[1].toLowerCase();
  const linkId = Number(perLink[2]);

  // /on_ID = usuÅ„ override (wraca do domyÅ›lnego trybu czatu)
  if (kind === "on") {
    const lang = getUserLang(user);
    const t = CMD_I18N[lang] || CMD_I18N.en;
    // zabezpieczenie: link musi naleÅ¼eÄ‡ do usera
    const chk = await dbQuery(
      `SELECT id FROM links WHERE id = $1 AND user_id = $2 LIMIT 1`,
      [Number(linkId), Number(user.id)]
    );
    if (!chk.rowCount) {
      await tgSend(chatId, t.linkNotYours(linkId));
      return;
    }

    await clearLinkNotificationMode(user.id, String(chatId), linkId);

    // odczytaj domyÅ›lny tryb czatu (Å¼eby Å‚adnie potwierdziÄ‡)
    const cn = await dbQuery(
      `SELECT mode FROM chat_notifications WHERE chat_id = $1 AND user_id = $2 LIMIT 1`,
      [String(chatId), Number(user.id)]
    );
    const chatModeRaw = (cn.rows[0]?.mode || "single").toLowerCase();
    const chatModePretty = modePretty(lang, chatModeRaw);
    await tgSend(chatId, t.linkEnabled(linkId, chatModePretty));
    return;
  }

  const mode = kind === "zbiorcze" ? "batch" : kind === "off" ? "off" : "single";
  const res = await setPerLinkMode(String(chatId), user.id, linkId, mode);

  if (!res.ok) {
    await tgSend(chatId, t.setModeFail(res.reason));
    return;
  }

  const pretty = modePretty(lang, res.mode);
  await tgSend(chatId, t.linkSet(linkId, pretty));
  return;
}

  if (command.startsWith("/start") || command.startsWith("/help")) {
    await handleHelp(msg);
  } else if (command.startsWith("/lista")) {
    await handleLista(msg, user);
  } else if (command.startsWith("/usun")) {
    await handleUsun(msg, user, argText);
  } else if (command.startsWith("/dodaj")) {
    await handleDodaj(msg, user, argText);
  } else if (command.startsWith("/status") || command.startsWith("/config")) {
    await handleStatus(msg, user);
  } else if (command === "/on") {
    await handleNotificationsOn(msg, user);
  } else if (command === "/off") {
    await handleNotificationsOff(msg, user);
  } else if (command === "/pojedyncze") {
    await handleModeSingle(msg, user);
  } else if (command === "/zbiorcze") {
    await handleModeBatch(msg, user);
  } else if (command.startsWith("/cisza_off")) {
    await handleQuietOff(msg);
  } else if (command.startsWith("/cisza")) {
    await handleQuiet(msg);
  } else if (command.startsWith("/lang")) {
    await handleLanguage(msg, user, argText);
  } else if (command.startsWith("/timezone") || command.startsWith("/tz") || command.startsWith("/strefa")) {
    await handleTimezone(msg, user);
  } else if (command.startsWith("/settings") || command.startsWith("/ustawienia")) {
    await handleSettings(msg, user);
  } else if (command.startsWith("/najnowsze")) {
    await handleNajnowsze(msg, user, argText);
  } else if (command.startsWith("/najtansze")) {
    await handleNajtansze(msg, user, argText);
  } else if (command.startsWith("/admin_reset")) {
    await handleAdminReset(msg, user, argText);
  } else {
    await tgSend(chatId, "â“ Nieznana komenda. UÅ¼yj /help.");
  }
}

// ---------- main loop ----------

async function main() {
  // Log startup to verify stdout is connected to docker logs
  process.stdout.write("[tg-bot] Starting telegram-bot service\n");
  console.log("telegram-bot.js start");

  await initDb();

  while (true) {
    try {
      const updates = await fetchUpdates();

      for (const u of updates) {
        offset = u.update_id + 1;
        try {
          await handleUpdate(u);
        } catch (e) {
          console.error("handleUpdate error:", e);
        }
      }
    } catch (e) {
      console.error("polling error:", e);
      // krÃ³tka pauza przy bÅ‚Ä™dach sieci
      await new Promise((r) => setTimeout(r, 1500));
    }
  }
}

main().catch((err) => {
  console.error("telegram-bot fatal error", err);
  process.exit(1);
});
