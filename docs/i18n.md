# i18n Architecture & Workflow

## ğŸŒ Core Principles

1. **EN is Master** - English dictionary is the single source of truth for keys
2. **1:1 Translation** - All languages must have identical key structure as EN
3. **No Hardcoded Strings** - All user-facing text goes through `t(lang, key, vars)`
4. **No Runtime Conditionals** - NEVER use `lang === "pl" ? ... : ...` in handlers
5. **Automatic Fallback** - Missing translations fall back to EN in `t()` function, not in handlers

## ğŸ“‹ Supported Languages

Current: `en` (master), `pl` (complete), `de`, `fr`, `hr`

## ğŸ›  Workflow for Adding New Language

### 1. Copy EN Dictionary

```javascript
// In api/i18n_unified.js
const TRANSLATIONS = {
  en: { /* master keys */ },
  pl: { /* complete */ },
  xx: {}, // Your new language
};
```

### 2. Translate Values

- Copy entire EN structure
- Replace English values with translations
- Keep placeholders intact: `{name}`, `{id}`, `{count}`
- Maintain HTML entities: `&lt;`, `&gt;`, `&l

t;code&gt;`, `<b>`

Example:
```javascript
xx: {
  cmd: {
    help_greeting: "ğŸ‘‹ Willkommen bei FindYourDeal!", // DE
    help_basic: "ğŸ“‹ <b>Grundbefehle</b>:",
    // ... all other keys from EN
  },
  status: { /* ... */ },
  mode: { /* ... */ },
  // ... all sections from EN
}
```

### 3. Run Completeness Check

```bash
npm run i18n:check
```

Expected output:
```
âœ… XX: Complete (155 keys)
```

If missing keys:
```
âŒ XX: Missing 5 keys:
   - cmd.help_greeting
   - status.title
   ...
```

Fix until all keys present.

### 4. Smoke Test

Test critical commands in Telegram with user set to new language:

```
/lang xx
/help     # Should show translated text
/status   # Check mode labels (not "mode: batch")
/cisza    # Check quiet hours messages
/lista    # Plain text format
```

### 5. Update getUserLang()

If adding new language code:

```javascript
// In api/i18n_unified.js normalizeLangCode()
const supported = ["pl", "de", "fr", "it", "es", "pt", "cs", "sk", "ro", "nl", "xx"];
```

## ğŸ§ª Pre-Deploy Checklist

- [ ] `npm run i18n:check` exits with code 0
- [ ] No `lang === "xx" ? ... : ...` in handlers
- [ ] No hardcoded strings like "OFF", "mode:", "Quiet hours disabled"
- [ ] All `t(lang, key)` calls have matching keys in EN
- [ ] Smoke test: `/lang xx â†’ /help â†’ /status` shows translated text

## ğŸš« Anti-Patterns to Avoid

### âŒ BAD: Runtime conditionals
```javascript
const text = lang === "pl" ? "Tryb ustawiony" : "Mode set";
```

### âœ… GOOD: i18n keys
```javascript
const text = t(lang, "notif.mode_set");
```

### âŒ BAD: Hardcoded labels
```javascript
const modeLabel = mode === "batch" ? "batch" : "single";
```

### âœ… GOOD: Translated labels
```javascript
const modeKey = mode === "batch" ? "mode.batch" : "mode.single";
const modeLabel = t(lang, modeKey);
```

### âŒ BAD: Fallback in handler
```javascript
await tgSend(chatId, t(lang, "quiet.disabled") || "Quiet hours disabled");
```

### âœ… GOOD: Rely on t() fallback
```javascript
await tgSend(chatId, t(lang, "quiet.disabled"));
// t() automatically falls back to EN if PL key missing
```

## ğŸ“ File Structure

```
api/
â”œâ”€â”€ i18n_unified.js        # Master translations + t() function
â”œâ”€â”€ i18n-check.js          # Completeness validation script
â”œâ”€â”€ telegram-bot.js        # Handlers using t(lang, key)
â””â”€â”€ package.json           # "i18n:check" npm script

docs/
â””â”€â”€ i18n.md                # This file
```

## ğŸ”§ Maintenance

### Adding New Key

1. Add to EN dict first
2. Run `npm run i18n:check` â†’ will show missing keys in other languages
3. Translate and add to all languages
4. Re-run `npm run i18n:check` until âœ…

### Removing Old Key

1. Remove from EN dict
2. Check `npm run i18n:check` for "Extra keys" warnings
3. Remove from all languages
4. Verify no code references old key (grep)

## ğŸ“Š Current Status

| Language | Status | Keys | Notes |
|----------|--------|------|-------|
| EN | âœ… Master | 155 | Source of truth |
| PL | âœ… Complete | 155 | Fully translated |
| DE | âš ï¸ Incomplete | ~20 | Falls back to EN |
| FR | âš ï¸ Incomplete | ~20 | Falls back to EN |
| HR | âš ï¸ Incomplete | ~20 | Falls back to EN |

## ğŸš€ CI/CD Integration

Add to pre-deploy checks:

```bash
npm run i18n:check || exit 1
```

This blocks deploy if any language has missing keys vs EN master.
